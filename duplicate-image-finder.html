<!-- Copyright by Vitali Fedulov (fedulov.vitali@gmail.com) 2015-2019 -->
<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Duplicate image finder</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="js/jquery.min.js"></script>
        <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto">
        <link rel="icon" type="image/png" href="images/favicon.png">
        <link rel="stylesheet" type="text/css" href="css/clustering.css">
    </head>
    <body>
        <div class="flex-container-select-files">
            <div class="flex-center-horizontally">
                <div>
                    <h1 class="text-centered clustering-title">Duplicate Image Finder</h1>
                </div>
                <div id="terms-of-service">
                    <p class="terms-of-service-header text-centered">Terms of service and data protection</p>
                    <div id="terms"></div>
                </div>
                <div>
                    <p id="messages" class="hidden">Messages</p>
                    <div id="ok-button" class="text-centered">
                        <div class="button">OK</div>
                    </div>
                    <div id="file-selector" class="text-centered">
                        <input class="hidden" type="file" id="filesSelected" webkitdirectory multiple accept="image/*" onchange="v49(this.files)" onclick="v11()">
                        <a class="button">Select a folder with images</a>
                    </div>
                    <div id="fast" class="fast-option">
                        <input type="checkbox" id="fast-option" onclick="v6()">
                        <div class="fast-option-text">Check here to accelerate the search. In rare cases this option may skip some images.</div>
                    </div>
                    <div class="link-block text-centered">
                        <a class="home-cancel-link" id="cancel-link" onclick="v51()">Cancel</a>
                        <a class="home-cancel-link" href="/">Home</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="fixed-top hidden">
            <div class="fixed-top-gray">
                <a href="index.html" class="myhref">
                    <span class="logo">
                        Similar<span class="logo-dot">.</span>Pictures
                    </span>
                </a>
                <div class="button button-new-search">New clustering</div>
            </div>
            <div class="fixed-white-1">
                <div class="progress">
                    <div id="progress-bar"></div>
                </div>
                <div class="progress-text"></div>
            </div>
            <div class="fixed-white-2 hidden">
                <span class="found-clusters"></span>
                <span>(</span>
                <span class="view-list">show/hide as list</span>
                <span>)</span>
                <textarea class="textarea"></textarea>
                <p class="explanation">
                    <small class="small">Scroll down to view all clusters. Keep the browser tab open to avoid stopping the clustering process.</small>
                </p>
            </div>
        </div>
        <div id="clusters" class="clusters"></div>
        <script>
            $(document).ready(function() {
                $("#terms").load("tos_en.html");
                v4();
                $("#ok-button").hide();
                $("#cancel-link").hide();
                $(".button-new-search").click(v62);
                $("#ok-button").click(v62);
            });

            var v75 = {

                v93: 24,
                v41: 12,
                v45: 80000,
                v10: 20 * 1024 * 1024,
                v73: 0,
                v65: 0,
                v21: Date.now(),

                v81: false,

                v92: 0,
                v99: [],
                v50: [],
                v79: [],
                v84: [],
                v76: [],
                v52: 0,
                v20: [],
                v33: 50,
                v67: 0.2,
                v72: 0.7,
                v132: 10,
                v121: 100,
                v42: [],
                v28: /(^image\/gif$)|(^image\/jpeg$)|(^image\/jpg$)|(^image\/bmp$)|(^image\/png$)|(^image\/webp$)/,
                v80: "",
                v39: (function() {
                    var v18 = new Uint32Array(10);
                    window.crypto.getRandomValues(v18);
                    var v37 = "";
                    for (var i = 0; i < v18.length; i++) {
                        v37 += v18[i].toString(36);
                    }
                    return v37
                }
                )(),

                v108: null,
                v53: 0,

                v25: false,

                v1: 1000,
                v0: null,
                v14: "image/jpeg",
                v9: 0.6,
                v35: 160,
                v34: '\n',
                v17: '\n\n',
                v16: 0,
                v12: false,
                v8: 0,
            };

            var v83 = {
                v32: v75.v41 * v75.v41,
                v123: v75.v93 * v75.v41,
                v90: v75.v93 * v75.v93,
            };

            function v5() {
                return Math.floor((Date.now() - v75.v21) / 1000);
            }

            function v6() {
                localStorage.setItem("fast-option", $("#fast-option")[0].checked);
                return;
            }

            function v4() {
                if (localStorage.getItem("fast-option") == "true") {
                    $("#fast-option")[0].checked = true;
                }
                return;
            }

            function v51() {
                v62();
            }

            function v62() {
                location.reload();
                $(document).ready(function() {
                    $(this).scrollTop(0);
                });
            }

            var v40 = document.getElementById('file-selector');
            v40.addEventListener('click', v26);

            function v26() {
                var v102 = document.getElementById('filesSelected');
                if (!!v102.webkitdirectory == false) {
                    alert('This browser does not support folder selection. Please try latest Chrome, Firefox or Edge.');
                    return;
                }
                v102.click();
            }

            function v43(v98, v106, v114, v78) {
                v98.readAsArrayBuffer(v114.slice(0, v75.v45));
                v98.onload = function(v107) {
                    var v101 = new Uint8Array(v107.target.result), v104, v135;
                    for (var v162 = 2; v162 < v101.length; v162++) {
                        if (v101[v162] == 0xFF) {
                            if (!v104) {
                                if (v101[v162 + 1] == 0xD8) {
                                    v104 = v162;
                                }
                            } else {
                                if (v101[v162 + 1] == 0xD9) {
                                    v135 = v162 + 2;
                                    break;
                                }
                            }
                        }
                    }
                    if (v104 && v135) {
                        v78(new Blob([v101.subarray(v104, v135)],{
                            type: "image/jpeg"
                        }));
                    } else {
                        v78(null);
                    }
                }
                ;

                v98.onerror = function() {
                    v78(null);
                }
                ;
            }

            function v23(v94) {
                if (v75.v16 < 2) {
                    $(".fixed-top").hide();
                    $(".flex-container-select-files").show();
                    $("#messages").text("The selected folder has less than 2 images of supported types. There is nothing to compare. Please select a different folder.");
                    $("#messages").show();
                    $("#file-selector").hide();
                    $("#cancel-link").hide();
                    $("#ok-button").show();
                    return;
                }
                $(".progress")[0].remove();
                var v156 = "s";
                if (v94 + 1 == 1) {
                    v156 = "";
                }
                v13(".progress-text", "Successfully scanned ".concat(v75.v108.length, " file", v156, "."));
                if (v75.v52 == 0) {
                    v13(".progress-text", "Zero similar images found from the successfully scanned ".concat(v75.v108.length, " file", v156, "."));
                }
                return;
            }

            function v69() {
                var v155 = 0
                  , v164 = 0
                  , v149 = 0
                  , v145 = 0
                  , v66 = 0;
                for (v155 = 1; v155 < v75.v93 - 1; v155++) {
                    for (v164 = 1; v164 < v75.v93 - 1; v164++) {
                        var v15 = new Map();
                        for (v149 = -1; v149 < 2; v149++) {
                            for (v145 = -1; v145 < 2; v145++) {
                                v15.set((v164 + v145) * v75.v93 + v155 + v149, true);
                            }
                        }
                        v75.v99[v66] = v15;
                        v75.v92++;
                        v66++;
                    }
                }
                return;
            }

            v69();
            var v71 = v75.v92 * v75.v33 * v75.v33 * v75.v67;
            function v58(v70) {

                var v146 = 0
                  , v148 = 0
                  , v100 = 0
                  , v127 = 0;
                var v150 = 0
                  , v142 = 0
                  , v147 = 0
                  , v151 = 0;
                var v57 = 0
                  , v61 = 0;
                var v96 = [];
                var v38 = [];
                var v36 = v54(v75.v50[v70]);
                loop1: for (v106 = v70 - 1; v106 >= 0; v106--) {
                    v150 = v75.v79[v106],
                    v142 = v75.v84[v106];
                    v147 = v75.v79[v70],
                    v151 = v75.v84[v70];
                    if (v150 * v151 * v75.v121 + v75.v132 * v150 * v147 < v147 * v142 * v75.v121 || v150 * v151 * v75.v121 > v147 * v142 * v75.v121 + v75.v132 * v150 * v147) {
                        continue loop1;
                    }

                    v120 = 0;
                    for (v82 = 0; v82 < v75.v92; v82++) {
                        v146 = v75.v50[v106][v82];
                        v148 = v75.v50[v70][v82];
                        v120 += (v146 - v148) * (v146 - v148);
                    }
                    if (v120 > v71) {
                        continue loop1;
                    }

                    v120 = 0;
                    v38 = v54(v75.v50[v106]);
                    for (v82 = 0; v82 < v75.v92; v82++) {
                        v146 = v38[v82];
                        v148 = v36[v82];
                        v120 += (v146 - v148) * (v146 - v148);
                    }
                    if (v120 > v71) {
                        continue loop1;
                    }

                    v120 = 0;
                    for (v82 = 0; v82 < v75.v92 - 1; v82++) {
                        v137 = v75.v50[v106][v82];
                        v136 = v75.v50[v106][v82 + 1];
                        v130 = v75.v50[v70][v82];
                        v133 = v75.v50[v70][v82 + 1];
                        if (((v137 > v136) && (v130 > v133)) || ((v137 < v136) && (v130 < v133)) || ((v137 == v136) && (v130 == v133))) {
                            v120++;
                        }
                    }
                    if (v120 < v75.v92 * v75.v72) {
                        continue loop1;
                    }

                    v57 = v75.v20[v106];
                    v61 = v75.v20[v70];

                    if (typeof v57 === "undefined" && typeof v61 === "undefined") {
                        v75.v20[v106] = v75.v52;
                        v75.v20[v70] = v75.v52;
                        v75.v76.push([v106, v70]);
                        v75.v52++;
                        v7(v75.v52 - 1);
                        v19(v75.v52 - 1, v106);
                        v19(v75.v52 - 1, v70);
                        continue;
                    }

                    if (typeof v57 === "number" && typeof v61 === "undefined") {
                        v96 = v75.v76[v57];
                        v96.push(v70);
                        v75.v20[v70] = v57;
                        v75.v76[v57] = v96;
                        v19(v57, v70);
                        continue;
                    }

                    if (typeof v57 === "undefined" && typeof v61 === "number") {
                        v96 = v75.v76[v61];
                        v96.push(v106);
                        v75.v20[v106] = v61;
                        v75.v76[v61] = v96;
                        v19(v61, v106);
                        continue;
                    }

                }
                v3();
                return;
            }

            function v13(v22, v117) {
                $(v22)[0].textContent = v117;
            }

            function v3() {
                var v156 = "s";
                if (v75.v52 == 1) {
                    v156 = "";
                }
                v13(".found-clusters", "Found ".concat(v75.v52, ' cluster', v156));
            }

            function v2(v94) {
                if (v94 + 1 == v75.v53) {
                    return;
                }
                v13(".progress-text", "Please wait... Reading ".concat(v94, ' from ', v75.v53, ' selected files.'));
                var v87 = Math.floor(100 * (v94 + 1) / v75.v53);
                if (v87 < 5) {
                    v87 = 5;
                }
                var v77 = "".concat(v87, "%");
                $("#progress-bar").width(v77);
            }
            function v85(v44, v31) {
                var v119 = document.createElement("div");
                v119.className = v44;
                v31.appendChild(v119);
                return v119;
            }

            var v46 = document.getElementById("clusters");

            function v7(v74) {
                var v60 = v85("cluster", v46);
                var v68 = v85("cluster-num", v60);
                v68.textContent = v74 + 1;
                var v27 = v85("cluster-content", v60);
                v85("cluster-imgs", v27);
                v85("cluster-paths", v27);
            }

            function v19(v74, v106) {
                var v86 = $(".cluster-imgs")[v74];
                var v97 = v85("cluster-img-div", v86);
                var v141 = new Image();
                v141.classList.add("cluster-img");
                v97.appendChild(v141);
                var v59 = v85("image-size", v97);
                var v24 = $(".cluster-paths")[v74];
                var v55 = v85("img-path", v24);
                var v114 = v75.v108[v75.v42[v106]];
                v55.textContent = v114.webkitRelativePath;
                v29(v114, v141, v59);
            }

            function v29(v114, v141, v59) {
                var v98 = new FileReader();
                v98.v114 = v114;
                v98.onload = function() {
                    return function(e) {
                        var v47 = new Image();
                        v47.src = e.target.result;
                        var v91 = document.createElement("canvas");
                        var v138 = v91.getContext("2d");
                        v47.onload = function() {
                            v59.textContent = "".concat(v47.width, "×", v47.height);
                            if (v47.width >= v47.height) {
                                v91.height = v75.v35 * 2;
                                v91.width = ~~(v47.width * v91.height / v47.height);
                            } else {
                                v91.width = v75.v35 * 2;
                                v91.height = ~~(v47.height * v91.width / v47.width);
                            }
                            v141.width = v91.width / 2;
                            v141.height = v91.height / 2;
                            v138.drawImage(v47, 0, 0, v91.width, v91.height);
                            v141.src = v91.toDataURL(v75.v14, v75.v9);
                            v91 = null;
                            v138 = null;
                            v47 = null;
                            v98 = null;
                            v75.v8++;
                        }
                        ;
                    }
                    ;
                }();
                v98.readAsDataURL(v114);
            }

            function v63() {
                var v113 = "";
                for (v158 = 0; v158 < v75.v52; v158++) {
                    var v64 = v75.v76[v158];
                    for (v162 = 0; v162 < v64.length - 1; v162++) {
                        v113 = v113.concat(v75.v108[v75.v42[v64[v162]]].webkitRelativePath, v75.v34);
                    }
                    v113 = v113.concat(v75.v108[v75.v42[v64[v162]]].webkitRelativePath, v75.v17);
                }
                v113 = v113.slice(0, -2);
                $(".textarea").val(v113);
                $(".textarea").toggleClass("textareaon");
            }

            function v11() {
                $("#terms-of-service").hide();
                $(".text-left").hide();
                $(".vertical-center-row").toggleClass("vertical-center-narrow");
                v75.v0 = setTimeout(function() {
                    $("#messages").text('Please wait if you selected a very large number of images: it may take tens of seconds before the clustering starts.');
                    $("#messages").show();
                    $("#file-selector").hide();
                    v75.v81 = $("#fast-option")[0].checked;
                    $("#fast").hide();
                    $("#cancel-link").show();
                }, v75.v1);
            }

            function v126(v161) {
                return Math.floor(Math.random() * v161);
            }

            function v163(v162, v154, v125) {
                return v125 * v154 + v162;
            }

            function v144(v163, v125) {
                var v154 = Math.floor(v163 / v125);
                var v162 = v163 - v125 * v154;
                return [v162, v154];
            }

            function v111(v88, v162, v154, v125) {
                var v165 = v88[v154 * (v125 * 4) + (v162 * 4)];
                var v157 = v88[v154 * (v125 * 4) + (v162 * 4) + 1];
                var v159 = v88[v154 * (v125 * 4) + (v162 * 4) + 2];
                var v153 = v88[v154 * (v125 * 4) + (v162 * 4) + 3];
                return [v165, v157, v159, v153];
            }

            function v56(v155, v164, v93) {
                if (v155 < 0 || v164 < 0 || v155 >= v93 || v164 >= v93) {
                    return true;
                }
                return false;
            }
            function v48(v88) {

                var v109 = [];
                var v162 = 0
                  , v154 = 0
                  , v152 = 0
                  , v161 = 0;
                var v165 = 0
                  , v157 = 0
                  , v159 = 0;
                var v134 = 0
                  , v156 = 0;
                var v82 = 0;
                var v103 = [];
                var v110 = [];
                var v89 = [];

                for (v143 = 0; v143 < v75.v99.length; v143++) {
                    v134 = 0;
                    v156 = 0;
                    for (var [v163,v105] of v75.v99[v143]) {
                        v103 = v144(v163, v75.v93);
                        v162 = v103[0];
                        v154 = v103[1];
                        for (v160 = 0; v160 < v83.v32; v160++) {
                            v110 = v144(v160, v75.v41);
                            v152 = v110[0];
                            v161 = v110[1];
                            v89 = v111(v88, v162 * v75.v41 + v152, v154 * v75.v41 + v161, v83.v123);
                            v165 = v89[0];
                            v157 = v89[1];
                            v159 = v89[2];
                            switch (v143 % 3) {
                            case 0:
                                v134 += v165;
                                v156++;
                                break;
                            case 1:
                                v134 += v157;
                                v156++;
                                break;
                            case 2:
                                v134 += v159;
                                v156++;
                            }
                        }

                    }
                    v109[v82] = v134 / v156;
                    v82++;
                }
                return v109;
            }

            function v54(v129) {
                var v95 = [];
                var v166 = v129.length;
                var v116 = 0;
                var v128 = Number.POSITIVE_INFINITY;
                var v115 = 0;
                var v124 = Number.POSITIVE_INFINITY;
                var v122 = 0;
                var v112 = Number.POSITIVE_INFINITY;
                for (v161 = 0; v161 < v166; v161 += 3) {
                    if (v129[v161] > v116) {
                        v116 = v129[v161];
                    }
                    if (v129[v161] < v128) {
                        v128 = v129[v161];
                    }
                }
                for (v161 = 1; v161 < v166; v161 += 3) {
                    if (v129[v161] > v115) {
                        v115 = v129[v161];
                    }
                    if (v129[v161] < v124) {
                        v124 = v129[v161];
                    }
                }
                for (v161 = 2; v161 < v166; v161 += 3) {
                    if (v129[v161] > v122) {
                        v122 = v129[v161];
                    }
                    if (v129[v161] < v112) {
                        v112 = v129[v161];
                    }
                }
                var v140 = v116 - v128;
                var v131 = v115 - v124;
                var v139 = v122 - v112;
                for (v161 = 0; v161 < v166; v161 += 3) {
                    v95[v161] = (v129[v161] - v128) * 255 / v140;
                }
                for (v161 = 1; v161 < v166; v161 += 3) {
                    v95[v161] = (v129[v161] - v124) * 255 / v131;
                }
                for (v161 = 2; v161 < v166; v161 += 3) {
                    v95[v161] = (v129[v161] - v112) * 255 / v139;
                }
                return v95;
            }

            function v49(v108) {
                v75.v8 = 0;
                clearTimeout(v75.v0);
                $("#file-selector").hide();
                v75.v108 = v108;
                v75.v80 = v108[0].webkitRelativePath.split("/")[0];
                v75.v53 = v108.length;
                var v94 = 0;
                var v106 = 0;
                var v98 = new FileReader();
                var v141 = new Image();
                var v91 = document.createElement("canvas");
                v91.width = v83.v123;
                v91.height = v83.v123;
                var v138 = v91.getContext("2d");
                $(".flex-container-select-files").hide();
                $(".fixed-top").show();
                $(".view-list").click(v63);
                $(".fixed-white-2").show();
                v3();
                v30(v94, v106, v98, v141, v138);
            }
            function v30(v94, v106, v98, v141, v138) {

                if (v94 >= v75.v53) {
                    v23(v94);
                    return;
                }

                if (!v75.v28.test(v75.v108[v94].type) || v75.v108[v94].size > v75.v10) {
                    v94++;
                    v30(v94, v106, v98, v141, v138);
                    return;
                }

                if (v75.v81 && v75.v108[v94].type == "image/jpeg" && !v75.v25) {

                    v43(v98, v106, v75.v108[v94], function(v118) {

                        if (v118 == null) {
                            v75.v25 = true;
                            v30(v94, v106, v98, v141, v138);
                            return;

                        } else {

                            v141.src = URL.createObjectURL(v118);

                            v141.onload = function() {

                                v75.v16++;
                                if (v94 < 5 || v94 % 5 === 0) {
                                    v2(v94);
                                }
                                v138.drawImage(v141, 0, 0, v83.v123, v83.v123);
                                v75.v50[v106] = v48(v138.getImageData(0, 0, v83.v123, v83.v123).data);
                                v75.v79[v106] = v141.width;
                                v75.v84[v106] = v141.height;

                                v75.v42[v106] = v94;
                                v75.v73 = v106 + 1;
                                v75.v65 = v94 + 1;

                                URL.revokeObjectURL(v141.src);
                                v58(v106);
                                v94++;
                                v106++;
                                if (!v75.v12) {
                                    v75.v12 = true;
                                }
                                v75.v25 = false;
                                v30(v94, v106, v98, v141, v138);
                                return;
                            }
                            ;

                            v141.onerror = function() {
                                URL.revokeObjectURL(v141.src);
                                v75.v25 = true;
                                v30(v94, v106, v98, v141, v138);
                                return;
                            }
                            ;

                            return;
                        }
                    });

                } else {
                    v75.v25 = true;
                }

                if (v75.v25 == false) {
                    return;
                }

                v98.readAsDataURL(v75.v108[v94]);

                v98.onerror = function() {
                    v94++;
                    v75.v25 = false;
                    v30(v94, v106, v98, v141, v138);
                    return;
                }
                ;

                v98.onload = function(evt) {
                    v141.src = evt.target.result;

                    v141.onerror = function() {
                        v94++;
                        v75.v25 = false;
                        v30(v94, v106, v98, v141, v138);
                        return;
                    }
                    ;

                    v141.onload = function() {
                        v75.v16++;
                        if (v94 < 5 || v94 % 5 === 0) {
                            v2(v94);
                        }
                        v138.drawImage(v141, 0, 0, v83.v123, v83.v123);
                        v75.v50[v106] = v48(v138.getImageData(0, 0, v83.v123, v83.v123).data);
                        v75.v79[v106] = v141.width;
                        v75.v84[v106] = v141.height;

                        v75.v42[v106] = v94;
                        v75.v73 = v106 + 1;
                        v75.v65 = v94 + 1;

                        v58(v106);

                        v94++;
                        v106++;

                        if (!v75.v12) {
                            v75.v12 = true;
                        }
                        v75.v25 = false;
                        v30(v94, v106, v98, v141, v138);
                        return;
                    }
                    ;
                }
                ;
            }
        </script>
    </body>
</html>

