<!-- Copyright by Vitali Fedulov (www.similar.pictures) 2015-2019 -->
<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Duplicate image finder</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="js/jquery.min.js"></script>
        <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto">
        <link rel="icon" type="image/png" href="images/favicon.png">
        <link rel="stylesheet" type="text/css" href="css/clustering.css">
    </head>
    <body>
        <div class="flex-container-select-files">
            <div class="flex-center-horizontally">
                <div>
                    <h1 class="text-centered clustering-title">Duplicate Image Finder</h1>
                </div>
                <div id="terms-of-service">
                    <p class="terms-of-service-header text-centered">Terms of service and data protection</p>
                    <div id="terms"></div>
                </div>
                <div>
                    <p id="messages" class="hidden">Messages</p>
                    <div id="ok-button" class="text-centered">
                        <div class="button">OK</div>
                    </div>
                    <div id="file-selector" class="text-centered">
                        <input class="hidden" type="file" id="filesSelected" webkitdirectory multiple accept="image/*" onchange="v47(this.files)" onclick="v14()">
                        <a class="button">Select a folder with images</a>
                    </div>
                    <div id="fast" class="fast-option">
                        <input type="checkbox" id="fast-option" onclick="v6()">
                        <div class="fast-option-text">Check here to accelerate the search. In rare cases this option may skip some images.</div>
                    </div>
                    <div class="link-block text-centered">
                        <a class="home-cancel-link" id="cancel-link" onclick="v48()">Cancel</a>
                        <a class="home-cancel-link" href="/">Home</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="fixed-top hidden">
            <div class="fixed-top-gray">
                <a href="index.html" class="myhref">
                    <span class="logo">
                        Similar<span class="logo-dot">.</span>
                        Pictures
                    </span>
                </a>
                <div class="button button-new-search">New clustering</div>
            </div>
            <div class="fixed-white-1">
                <div class="progress">
                    <div id="progress-bar"></div>
                </div>
                <div class="progress-text"></div>
            </div>
            <div class="fixed-white-2 hidden">
                <span class="found-clusters"></span>
                <span>(</span>
                <span class="view-list">show/hide as list</span>
                <span>)</span>
                <textarea class="textarea"></textarea>
                <p class="explanation">
                    <small class="small">Scroll down to view all clusters. Keep the browser tab open to avoid stopping the clustering process.</small>
                </p>
            </div>
        </div>
        <div id="clusters" class="clusters"></div>
        <script>
            $(document).ready(function() {
                $("#terms").load("tos_en.html");
                v4();
                $("#ok-button").hide();
                $("#cancel-link").hide();
                $(".button-new-search").click(v65);
                $("#ok-button").click(v65);
            });

            var v81 = {

                v90: 24,
                v40: 12,
                v53: 80000,
                v9: 20 * 1024 * 1024,
                v71: 0,
                v61: 0,
                v19: Date.now(),

                v74: false,

                v99: 0,
                v106: [],
                v49: [],
                v77: [],
                v82: [],
                v76: [],
                v51: 0,
                v17: [],
                v32: 50,
                v12: 0.95,
                v132: 10,
                v125: 100,
                v36: [],
                v29: /(^image\/gif$)|(^image\/jpeg$)|(^image\/jpg$)|(^image\/bmp$)|(^image\/png$)|(^image\/webp$)/,
                v78: "",
                v44: (function() {
                    var v18 = new Uint32Array(10);
                    window.crypto.getRandomValues(v18);
                    var v37 = "";
                    for (var i = 0; i < v18.length; i++) {
                        v37 += v18[i].toString(36);
                    }
                    return v37
                }
                )(),

                v109: null,
                v56: 0,

                v26: false,

                v1: 1000,
                v0: null,
                v11: "image/jpeg",
                v8: 0.6,
                v42: 160,
                v35: '\n',
                v22: '\n\n',
                v21: 0,
                v15: false,
                v7: 0,
            };

            var v80 = {
                v33: v81.v40 * v81.v40,
                v115: v81.v90 * v81.v40,
                v88: v81.v90 * v81.v90,
            };

            function v5() {
                return Math.floor((Date.now() - v81.v19) / 1000);
            }

            function v6() {
                localStorage.setItem("fast-option", $("#fast-option")[0].checked);
                return;
            }

            function v4() {
                if (localStorage.getItem("fast-option") == "true") {
                    $("#fast-option")[0].checked = true;
                }
                return;
            }

            function v48() {
                v65();
            }

            function v65() {
                location.reload();
                $(document).ready(function() {
                    $(this).scrollTop(0);
                });
            }

            var v41 = document.getElementById('file-selector');
            v41.addEventListener('click', v27);

            function v27() {
                var v100 = document.getElementById('filesSelected');
                if (!!v100.webkitdirectory == false) {
                    alert('This browser does not support folder selection. Please try latest Chrome, Firefox or Edge.');
                    return;
                }
                v100.click();
            }

            function v47(v109) {
                v81.v7 = 0;
                clearTimeout(v81.v0);
                $("#file-selector").hide();
                v81.v109 = v109;
                v81.v78 = v109[0].webkitRelativePath.split("/")[0];
                v81.v56 = v109.length;
                var v98 = 0;
                var v107 = 0;
                var v96 = new FileReader();
                var v129 = new Image();
                var v93 = document.createElement("canvas");
                v93.width = v80.v115;
                v93.height = v80.v115;
                var v137 = v93.getContext("2d");
                $(".flex-container-select-files").hide();
                $(".fixed-top").show();
                $(".view-list").click(v59);
                $(".fixed-white-2").show();
                v3();
                v31(v98, v107, v96, v129, v137);
            }
            function v31(v98, v107, v96, v129, v137) {

                if (v98 >= v81.v56) {
                    v23(v98);
                    return;
                }

                if (!v81.v29.test(v81.v109[v98].type) || v81.v109[v98].size > v81.v9) {
                    v98++;
                    v31(v98, v107, v96, v129, v137);
                    return;
                }

                if (v81.v74 && v81.v109[v98].type == "image/jpeg" && !v81.v26) {

                    v38(v96, v107, v81.v109[v98], function(v126) {

                        if (v126 == null) {
                            v81.v26 = true;
                            v31(v98, v107, v96, v129, v137);
                            return;

                        } else {

                            v129.src = URL.createObjectURL(v126);

                            v129.onload = function() {

                                v81.v21++;
                                if (v98 < 5 || v98 % 5 === 0) {
                                    v2(v98);
                                }
                                v137.drawImage(v129, 0, 0, v80.v115, v80.v115);
                                v81.v49[v107] = v45(v137.getImageData(0, 0, v80.v115, v80.v115).data);
                                v81.v77[v107] = v129.width;
                                v81.v82[v107] = v129.height;

                                v81.v36[v107] = v98;
                                v81.v71 = v107 + 1;
                                v81.v61 = v98 + 1;

                                URL.revokeObjectURL(v129.src);
                                v63(v107);
                                v98++;
                                v107++;
                                if (!v81.v15) {
                                    v81.v15 = true;
                                }
                                v81.v26 = false;
                                v31(v98, v107, v96, v129, v137);
                                return;
                            }
                            ;

                            v129.onerror = function() {
                                URL.revokeObjectURL(v129.src);
                                v81.v26 = true;
                                v31(v98, v107, v96, v129, v137);
                                return;
                            }
                            ;

                            return;
                        }
                    });

                } else {
                    v81.v26 = true;
                }

                if (v81.v26 == false) {
                    return;
                }

                v96.readAsDataURL(v81.v109[v98]);

                v96.onerror = function() {
                    v98++;
                    v81.v26 = false;
                    v31(v98, v107, v96, v129, v137);
                    return;
                }
                ;

                v96.onload = function(evt) {
                    v129.src = evt.target.result;

                    v129.onerror = function() {
                        v98++;
                        v81.v26 = false;
                        v31(v98, v107, v96, v129, v137);
                        return;
                    }
                    ;

                    v129.onload = function() {
                        v81.v21++;
                        if (v98 < 5 || v98 % 5 === 0) {
                            v2(v98);
                        }
                        v137.drawImage(v129, 0, 0, v80.v115, v80.v115);
                        v81.v49[v107] = v45(v137.getImageData(0, 0, v80.v115, v80.v115).data);
                        v81.v77[v107] = v129.width;
                        v81.v82[v107] = v129.height;

                        v81.v36[v107] = v98;
                        v81.v71 = v107 + 1;
                        v81.v61 = v98 + 1;

                        v63(v107);

                        v98++;
                        v107++;

                        if (!v81.v15) {
                            v81.v15 = true;
                        }
                        v81.v26 = false;
                        v31(v98, v107, v96, v129, v137);
                        return;
                    }
                    ;
                }
                ;
            }

            function v38(v96, v107, v119, v79) {
                v96.readAsArrayBuffer(v119.slice(0, v81.v53));
                v96.onload = function(v111) {
                    var v110 = new Uint8Array(v111.target.result), v105, v130;
                    for (var v159 = 2; v159 < v110.length; v159++) {
                        if (v110[v159] == 0xFF) {
                            if (!v105) {
                                if (v110[v159 + 1] == 0xD8) {
                                    v105 = v159;
                                }
                            } else {
                                if (v110[v159 + 1] == 0xD9) {
                                    v130 = v159 + 2;
                                    break;
                                }
                            }
                        }
                    }
                    if (v105 && v130) {
                        v79(new Blob([v110.subarray(v105, v130)],{
                            type: "image/jpeg"
                        }));
                    } else {
                        v79(null);
                    }
                }
                ;

                v96.onerror = function() {
                    v79(null);
                }
                ;
            }

            function v23(v98) {
                if (v81.v21 < 2) {
                    $(".fixed-top").hide();
                    $(".flex-container-select-files").show();
                    $("#messages").text("The selected folder has less than 2 images of supported types. There is nothing to compare. Please select a different folder.");
                    $("#messages").show();
                    $("#file-selector").hide();
                    $("#cancel-link").hide();
                    $("#ok-button").show();
                    return;
                }
                $(".progress")[0].remove();
                var v156 = "s";
                if (v98 + 1 == 1) {
                    v156 = "";
                }
                v16(".progress-text", "Successfully scanned ".concat(v81.v109.length, " file", v156, "."));
                if (v81.v51 == 0) {
                    v16(".progress-text", "Zero similar images found from the successfully scanned ".concat(v81.v109.length, " file", v156, "."));
                }
                return;
            }
            function v63(v73) {
                var v145 = 0
                  , v144 = 0
                  , v108 = 0
                  , v123 = 0;
                var v66 = 0
                  , v92 = 0
                  , v94 = 0;
                var v142 = 0
                  , v146 = 0
                  , v138 = 0
                  , v140 = 0;
                var v55 = 0
                  , v60 = 0;
                var v95 = [];
                var v43 = [];
                var v39 = v67(v81.v49[v73]);
                loop1: for (v107 = v73 - 1; v107 >= 0; v107--) {
                    v142 = v81.v77[v107],
                    v146 = v81.v82[v107];
                    v138 = v81.v77[v73],
                    v140 = v81.v82[v73];
                    if (v142 * v140 * v81.v125 + v81.v132 * v142 * v138 < v138 * v146 * v81.v125 || v142 * v140 * v81.v125 > v138 * v146 * v81.v125 + v81.v132 * v142 * v138) {
                        continue loop1;
                    }

                    v108 = 0;
                    v123 = 0;
                    for (v75 = 0; v75 < v81.v99; v75++) {
                        v145 = v81.v49[v107][v75];
                        v144 = v81.v49[v73][v75];
                        v108 = Math.abs(v145 - v144);
                        if (v108 <= v81.v32) {
                            v123 += v108;
                        }
                        if (v108 > v81.v32) {
                            continue loop1;
                        }
                    }
                    if (v123 > v81.v99 * v81.v32 * 0.5) {
                        continue loop1;
                    }

                    v66 = 0;
                    v92 = 0,
                    v94 = 0;
                    for (v75 = 0; v75 < v81.v99; v75++) {
                        v145 = v81.v49[v107][v75];
                        v144 = v81.v49[v73][v75];
                        v66 += v145 * v144;
                        v92 += v145 * v145;
                        v94 += v144 * v144;
                    }
                    if (v66 * v66 < v81.v12 * v92 * v94) {
                        continue loop1;
                    }

                    v43 = v67(v81.v49[v107]);
                    v66 = 0;
                    v92 = 0,
                    v94 = 0;
                    for (v75 = 0; v75 < v81.v99; v75++) {
                        v145 = v43[v75];
                        v144 = v39[v75];
                        v66 += v145 * v144;
                        v92 += v145 * v145;
                        v94 += v144 * v144;
                    }
                    if (v66 * v66 < v81.v12 * v92 * v94) {
                        continue loop1;
                    }

                    v55 = v81.v17[v107];
                    v60 = v81.v17[v73];

                    if (typeof v55 === "undefined" && typeof v60 === "undefined") {
                        v81.v17[v107] = v81.v51;
                        v81.v17[v73] = v81.v51;
                        v81.v76.push([v107, v73]);
                        v81.v51++;
                        v10(v81.v51 - 1);
                        v20(v81.v51 - 1, v107);
                        v20(v81.v51 - 1, v73);
                        continue;
                    }

                    if (typeof v55 === "number" && typeof v60 === "undefined") {
                        v95 = v81.v76[v55];
                        v95.push(v73);
                        v81.v17[v73] = v55;
                        v81.v76[v55] = v95;
                        v20(v55, v73);
                        continue;
                    }

                    if (typeof v55 === "undefined" && typeof v60 === "number") {
                        v95 = v81.v76[v60];
                        v95.push(v107);
                        v81.v17[v107] = v60;
                        v81.v76[v60] = v95;
                        v20(v60, v107);
                        continue;
                    }

                }
                v3();
                return;
            }

            function v16(v24, v120) {
                $(v24)[0].textContent = v120;
            }

            function v3() {
                var v156 = "s";
                if (v81.v51 == 1) {
                    v156 = "";
                }
                v16(".found-clusters", "Found ".concat(v81.v51, ' cluster', v156));
            }

            function v2(v98) {
                if (v98 + 1 == v81.v56) {
                    return;
                }
                v16(".progress-text", "Please wait... Reading ".concat(v98, ' from ', v81.v56, ' selected files.'));
                var v85 = Math.floor(100 * (v98 + 1) / v81.v56);
                if (v85 < 5) {
                    v85 = 5;
                }
                var v83 = "".concat(v85, "%");
                $("#progress-bar").width(v83);
            }
            function v84(v52, v34) {
                var v113 = document.createElement("div");
                v113.className = v52;
                v34.appendChild(v113);
                return v113;
            }

            var v50 = document.getElementById("clusters");

            function v10(v69) {
                var v54 = v84("cluster", v50);
                var v70 = v84("cluster-num", v54);
                v70.textContent = v69 + 1;
                var v30 = v84("cluster-content", v54);
                v84("cluster-imgs", v30);
                v84("cluster-paths", v30);
            }

            function v20(v69, v107) {
                var v87 = $(".cluster-imgs")[v69];
                var v91 = v84("cluster-img-div", v87);
                var v129 = new Image();
                v129.classList.add("cluster-img");
                v91.appendChild(v129);
                var v58 = v84("image-size", v91);
                var v25 = $(".cluster-paths")[v69];
                var v62 = v84("img-path", v25);
                var v119 = v81.v109[v81.v36[v107]];
                v62.textContent = v119.webkitRelativePath;
                v28(v119, v129, v58);
            }

            function v28(v119, v129, v58) {
                var v96 = new FileReader();
                v96.v119 = v119;
                v96.onload = function() {
                    return function(e) {
                        var v46 = new Image();
                        v46.src = e.target.result;
                        var v93 = document.createElement("canvas");
                        var v137 = v93.getContext("2d");
                        v46.onload = function() {
                            v58.textContent = "".concat(v46.width, "×", v46.height);
                            if (v46.width >= v46.height) {
                                v93.height = v81.v42 * 2;
                                v93.width = ~~(v46.width * v93.height / v46.height);
                            } else {
                                v93.width = v81.v42 * 2;
                                v93.height = ~~(v46.height * v93.width / v46.width);
                            }
                            v129.width = v93.width / 2;
                            v129.height = v93.height / 2;
                            v137.drawImage(v46, 0, 0, v93.width, v93.height);
                            v129.src = v93.toDataURL(v81.v11, v81.v8);
                            v93 = null;
                            v137 = null;
                            v46 = null;
                            v96 = null;
                            v81.v7++;
                        }
                        ;
                    }
                    ;
                }();
                v96.readAsDataURL(v119);
            }

            function v59() {
                var v124 = "";
                for (v153 = 0; v153 < v81.v51; v153++) {
                    var v57 = v81.v76[v153];
                    for (v159 = 0; v159 < v57.length - 1; v159++) {
                        v124 = v124.concat(v81.v109[v81.v36[v57[v159]]].webkitRelativePath, v81.v35);
                    }
                    v124 = v124.concat(v81.v109[v81.v36[v57[v159]]].webkitRelativePath, v81.v22);
                }
                v124 = v124.slice(0, -2);
                $(".textarea").val(v124);
                $(".textarea").toggleClass("textareaon");
            }

            function v14() {
                $("#terms-of-service").hide();
                $(".text-left").hide();
                $(".vertical-center-row").toggleClass("vertical-center-narrow");
                v81.v0 = setTimeout(function() {
                    $("#messages").text('Please wait if you selected a very large number of images: it may take tens of seconds before the clustering starts.');
                    $("#messages").show();
                    $("#file-selector").hide();
                    v81.v74 = $("#fast-option")[0].checked;
                    $("#fast").hide();
                    $("#cancel-link").show();
                }, v81.v1);
            }

            function v121(v152) {
                return Math.floor(Math.random() * v152);
            }

            function v148(v159, v155, v116) {
                return v116 * v155 + v159;
            }

            function v139(v148, v116) {
                var v155 = Math.floor(v148 / v116);
                var v159 = v148 - v116 * v155;
                return [v159, v155];
            }

            function v122(v89, v159, v155, v116) {
                var v151 = v89[v155 * (v116 * 4) + (v159 * 4)];
                var v150 = v89[v155 * (v116 * 4) + (v159 * 4) + 1];
                var v161 = v89[v155 * (v116 * 4) + (v159 * 4) + 2];
                var v157 = v89[v155 * (v116 * 4) + (v159 * 4) + 3];
                return [v151, v150, v161, v157];
            }

            function v68() {
                var v154 = 0
                  , v158 = 0
                  , v143 = 0
                  , v141 = 0
                  , v72 = 0;
                for (v154 = 1; v154 < v81.v90 - 1; v154++) {
                    for (v158 = 1; v158 < v81.v90 - 1; v158++) {
                        var v13 = new Map();
                        for (v143 = -1; v143 < 2; v143++) {
                            for (v141 = -1; v141 < 2; v141++) {
                                v13.set((v158 + v141) * v81.v90 + v154 + v143, true);
                            }
                        }
                        v81.v106[v72] = v13;
                        v81.v99++;
                        v72++;
                    }
                }
                return;
            }

            v68();

            function v64(v154, v158, v90) {
                if (v154 < 0 || v158 < 0 || v154 >= v90 || v158 >= v90) {
                    return true;
                }
                return false;
            }
            function v45(v89) {

                var v104 = [];
                var v159 = 0
                  , v155 = 0
                  , v149 = 0
                  , v152 = 0;
                var v151 = 0
                  , v150 = 0
                  , v161 = 0;
                var v133 = 0
                  , v156 = 0;
                var v75 = 0;
                var v101 = [];
                var v102 = [];
                var v86 = [];

                for (v147 = 0; v147 < v81.v106.length; v147++) {
                    v133 = 0;
                    v156 = 0;
                    for (var [v148,v103] of v81.v106[v147]) {
                        v101 = v139(v148, v81.v90);
                        v159 = v101[0];
                        v155 = v101[1];
                        for (v162 = 0; v162 < v80.v33; v162++) {
                            v102 = v139(v162, v81.v40);
                            v149 = v102[0];
                            v152 = v102[1];
                            v86 = v122(v89, v159 * v81.v40 + v149, v155 * v81.v40 + v152, v80.v115);
                            v151 = v86[0];
                            v150 = v86[1];
                            v161 = v86[2];
                            switch (v147 % 3) {
                            case 0:
                                v133 += v151;
                                v156++;
                                break;
                            case 1:
                                v133 += v150;
                                v156++;
                                break;
                            case 2:
                                v133 += v151 + v150 + v161;
                                v156 += 3;
                            }
                        }

                    }
                    v104[v75] = v133 / v156;
                    v75++;
                }
                return v104;
            }

            function v67(v135) {
                var v97 = [];
                var v160 = v135.length;
                var v112 = 0;
                var v127 = Number.POSITIVE_INFINITY;
                var v128 = 0;
                var v117 = Number.POSITIVE_INFINITY;
                var v114 = 0;
                var v118 = Number.POSITIVE_INFINITY;
                for (v152 = 0; v152 < v160; v152 += 3) {
                    if (v135[v152] > v112) {
                        v112 = v135[v152];
                    }
                    if (v135[v152] < v127) {
                        v127 = v135[v152];
                    }
                }
                for (v152 = 1; v152 < v160; v152 += 3) {
                    if (v135[v152] > v128) {
                        v128 = v135[v152];
                    }
                    if (v135[v152] < v117) {
                        v117 = v135[v152];
                    }
                }
                for (v152 = 2; v152 < v160; v152 += 3) {
                    if (v135[v152] > v114) {
                        v114 = v135[v152];
                    }
                    if (v135[v152] < v118) {
                        v118 = v135[v152];
                    }
                }
                var v131 = v112 - v127;
                var v136 = v128 - v117;
                var v134 = v114 - v118;
                for (v152 = 0; v152 < v160; v152 += 3) {
                    v97[v152] = (v135[v152] - v127) * 255 / v131;
                }
                for (v152 = 1; v152 < v160; v152 += 3) {
                    v97[v152] = (v135[v152] - v117) * 255 / v136;
                }
                for (v152 = 2; v152 < v160; v152 += 3) {
                    v97[v152] = (v135[v152] - v118) * 255 / v134;
                }
                return v97;
            }
        </script>
    </body>
</html>
