<!-- Copyright by Vitali Fedulov (www.similar.pictures) 2015-2019 --> <!DOCTYPE html> <html lang="en"> <head> <title>Similar image search on disk</title> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1"> <script src="js/jquery.min.js"></script> <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto"> </head> <link rel="icon" type="image/png" href="images/favicon.png"> <link rel="stylesheet" type="text/css" href="css/clustering.css"> <body> <div class="flex-container-select-files"> <div class="flex-center-horizontally"> <div> <h1 class="text-centered clustering-title">Similar Image Search</h1> </div> <div id="terms-of-service"> <p class="terms-of-service-header text-centered">Terms of service and data protection</p> <div id="terms"></div> </div> <div> <p id="messages" class="hidden">Messages</p> <div id="ok-button" class="text-centered"> <div class="button">OK</div> </div> <div id="image-selector" class="text-centered margin-bottom"> <input type="file" accept="image/*" class="hidden" id="imageSelected" onchange="v7(this.files)"> <a class="button" id="button-image-select"> 1. Select image to search </a> </div> <div id="folder-selector" class="text-centered"> <input type="file" accept="image/*" webkitdirectory multiple class="hidden" id="filesSelected" onchange="v51(this.files)" onclick="v16()"> <a class="button button-passive" id="button-folder-select"> 2. Where to search (select folder) </a> </div> <div id="fast" class="fast-option"> <input type="checkbox" id="fast-option" onclick="v8()"> <div class="fast-option-text">Faster scan option. It may miss old or edited JPEGs, because it uses embedded thumbnails, which are sometimes incorrect.</div> </div> <div class="link-block text-centered"> <a class="home-cancel-link" id="cancel-link" onclick="v53()">Cancel</a> <a class="home-cancel-link" href="/">Home</a> </div> </div> </div> </div> <div class="fixed-top hidden"> <div class="fixed-top-gray"> <a href = "index.html" class="myhref"><span class="logo">Similar<span class="logo-dot">.</span>Pictures</span></a> <div class="button button-new-search">New search</div> </div> <div class="fixed-white-1"> <div class="progress"> <div id="progress-bar"></div> </div> <div class="progress-text"></div> </div> <div class="fixed-white-2 hidden"> <span class="found-clusters"></span> <span> (</span><span class="view-list">show/hide as list</span><span>)</span> <textarea class="textarea"></textarea> <p class="explanation"> <small class="small">The most similar images appear on top. Keep the browser tab open to avoid stopping the search.</small> </p> </div> </div> <div id="clusters" class="found-images"></div> <script> $(document).ready(function() { $("#terms").load("tos_en.html"); v5(); $("#ok-button").hide(); $("#cancel-link").hide(); $(".button-new-search").click(v61); $("#ok-button").click(v61); }); var v74 = { v91 : 24, v44 : 12, v49 : 80000, v11 : 20*1024*1024, v68 : 0, v60 : 0, v21 : Date.now(), v70 : false, v90 : 0, v101 : [], v106 : [], v147 : 0, v135 : 0, v46 : [], v96 : [], v148 : 0, v142 : 0, v54 : 0, v40 : [], v33 : [], v36 : 50, v14 : 0.95, v131 : 10, v116 : 100, v42 : [], v31 : /(^image\/gif$)|(^image\/jpeg$)|(^image\/jpg$)|(^image\/bmp$)|(^image\/png$)|(^image\/webp$)/, v75 : "", v48 : (function () { var v22 = new Uint32Array(10); window.crypto.getRandomValues(v22); var v45 = ""; var v153 = 0; for (v153 = 0; v153 < v22.length; v153++) { v45 += v22[v153].toString(36); } return v45 }) (), v102 : null, v65 : 0, v29 : false, v1 : 1000, v0 : null, v12 : "image/jpeg", v9 : 0.6, v43 : 160, v37 : '\n', v20 : 0, v17 : false, v10 : 0, }; var v73 = { v34 : v74.v44 * v74.v44, v122 : v74.v91 * v74.v44, v78 : v74.v91 * v74.v91, }; function v4() { return Math.floor((Date.now() - v74.v21) / 1000); } function v8() { localStorage.setItem("fast-option", $("#fast-option")[0].checked); return; } function v5() { if (localStorage.getItem("fast-option") == "true") { $("#fast-option")[0].checked = true; } return; } function v53() { v61(); } function v61() { location.reload(); $(document).ready(function(){ $(this).scrollTop(0); }); } document.getElementById('image-selector').addEventListener('click', v25); function v25() { document.getElementById('imageSelected').click(); } function v13() { document.getElementById('image-selector').removeEventListener('click', v25); document.getElementById('folder-selector').addEventListener('click', v19); $("#button-image-select").toggleClass("button-passive"); $("#button-folder-select").toggleClass("button-passive"); $("#cancel-link").show(); } function v19() { var v97 = document.getElementById('filesSelected'); if (!!v97.webkitdirectory == false) { alert('This browser does not support folder selection. Please try latest Chrome, Firefox or Edge.'); return; } v97.click(); } function v7(v102) { const v35 = v102[0]; var v93 = new FileReader(); var v126 = new Image(); var v94 = document.createElement("canvas"); v94.width = v73.v122; v94.height = v73.v122; var v134 = v94.getContext("2d"); v6(); v93.onerror = function() { v28(); return; }; v93.onload = function() { return function(e) { v126.src = e.target.result; v126.onerror = function() { v28(); return; }; v126.onload = function() { return function(e2) { v134.drawImage(v126, 0, 0, v73.v122, v73.v122); v74.v106 = v50(v134.getImageData(0, 0, v73.v122, v73.v122).data); v74.v46 = v58(v74.v106); v74.v147 = v126.width; v74.v135 = v126.height; v13(); }; } (); }; } (); v93.readAsDataURL(v102[0]); } function v28() { $("#messages").text('ERROR. The selected image cannot be read. Please select another image (or the same image in a different format).'); $("#messages").show(); $("#cancel-link").show(); } function v6() { $("#terms-of-service").show(); $("#messages").hide(); $("#cancel-link").hide(); } function v51(v102) { v74.v10 = 0; clearTimeout(v74.v0); $("#folder-selector").hide(); v74.v102 = v102; v74.v75 = v102[0].webkitRelativePath.split("/")[0]; v74.v65 = v102.length; var v88 = 0; var v95 = 0; var v93 = new FileReader(); var v126 = new Image(); var v94 = document.createElement("canvas"); v94.width = v73.v122; v94.height = v73.v122; var v134 = v94.getContext("2d"); $(".flex-container-select-files").hide(); $(".fixed-top").show(); $(".view-list").click(v62); $(".fixed-white-2").show(); v2(); v38(v88, v95, v93, v126, v134); } function v38(v88, v95, v93, v126, v134) { if (v88 >= v74.v65) { v26(v88); return; } if (!v74.v31.test(v74.v102[v88].type) || v74.v102[v88].size > v74.v11) { v88++; v38(v88, v95, v93, v126, v134); return; } if (v74.v70 && v74.v102[v88].type == "image/jpeg" && !v74.v29) { v47(v93, v95, v74.v102[v88], function(v117) { if (v117 == null) { v74.v29 = true; v38(v88, v95, v93, v126, v134); return; } else { v126.onload = function() { v74.v20++; if (v88 < 5 || v88 % 5 === 0) { v3(v88); } v134.drawImage(v126, 0, 0, v73.v122, v73.v122); v74.v96 = v50(v134.getImageData(0, 0, v73.v122, v73.v122).data); v74.v148 = v126.width; v74.v142 = v126.height; v74.v68 = v95 + 1; v74.v60 = v88 + 1; if (v79(v88)) { v74.v54++; v27(v88); v2(); } v88++; v95++; if (!v74.v17) { v74.v17 = true; } v74.v29 = false; URL.revokeObjectURL(v126.src); v38(v88, v95, v93, v126, v134); return; }; v126.onerror = function() { URL.revokeObjectURL(v126.src); v74.v29 = true; v38(v88, v95, v93, v126, v134); return; }; v126.src = URL.createObjectURL(v117); return; } }); } else { v74.v29 = true; } if (v74.v29 == false) { return; } v93.readAsDataURL(v74.v102[v88]); v93.onerror = function() { v88++; v74.v29 = false; v38(v88, v95, v93, v126, v134); return; }; v93.onload = function(evt) { v126.src = evt.target.result; v126.onerror = function() { v88++; v74.v29 = false; v38(v88, v95, v93, v126, v134); return; }; v126.onload = function() { v74.v20++; if (v88 < 5 || v88 % 5 === 0) { v3(v88); } v134.drawImage(v126, 0, 0, v73.v122, v73.v122); v74.v96 = v50(v134.getImageData(0, 0, v73.v122, v73.v122).data); v74.v148 = v126.width; v74.v142 = v126.height; v74.v68 = v95 + 1; v74.v60 = v88 + 1; if (v79(v88)) { v74.v54++; v27(v88); v2(); } v88++; v95++; if (!v74.v17) { v74.v17 = true; } v74.v29 = false; URL.revokeObjectURL(v126.src); v38(v88, v95, v93, v126, v134); return; }; }; } function v47(v93, v95, v120, v71) { v93.readAsArrayBuffer(v120.slice(0, v74.v49)); v93.onload = function (v98) { var v105 = new Uint8Array(v98.target.result), v99, v128; for (var v153 = 2; v153 < v105.length; v153++) { if (v105[v153] == 0xFF) { if (!v99) { if (v105[v153 + 1] == 0xD8) { v99 = v153; } } else { if (v105[v153 + 1] == 0xD9) { v128 = v153 + 2; break; } } } } if (v99 && v128) { v71(new Blob([v105.subarray(v99, v128)], {type:"image/jpeg"})); } else { v71(null); } }; v93.onerror = function() { v71(null); }; } function v26(v88) { if (v74.v20 < 2) { $(".fixed-top").hide(); $(".flex-container-select-files").show(); $("#messages").text("The selected folder has less than 2 images of supported types. There is nothing to compare. Please select a different folder."); $("#messages").show(); $("#folder-selector").hide(); $("#cancel-link").hide(); $("#ok-button").show(); return; } $(".progress")[0].remove(); var v157 = "s"; if (v88 + 1 == 1) { v157 = ""; } v15(".progress-text", "Successfully scanned ".concat(v74.v102.length, " file", v157, ".")); if (v74.v54 == 0) { v15(".progress-text", "Zero similar images found from the successfully scanned ".concat(v74.v102.length, " file", v157, ".")); } return; } function v79(v88) { var v140 = 0, v138 = 0, v123 = 0, v84 = 0; var v59 = 0, v86 = 0, v89 = 0; var v139 = 0, v136 = 0, v145 = 0, v141 = 0; v139 = v74.v147, v136 = v74.v135; v145 = v74.v148, v141 = v74.v142; if (v139 * v141 * v74.v116 + v74.v131 * v139 * v145 < v145 * v136* v74.v116 || v139 * v141 * v74.v116 > v145 * v136 * v74.v116 + v74.v131 * v139 * v145) { return false; } for (v76 = 0; v76 < v74.v90; v76++) { v140 = v74.v106[v76]; v138 = v74.v96[v76]; v123 = Math.abs(v140 - v138); if (v123 > v74.v36) { return false; } v84 += v123; } for (v76 = 0; v76 < v74.v90; v76++) { v140 = v74.v106[v76]; v138 = v74.v96[v76]; v59 += v140 * v138; v86 += v140 * v140; v89 += v138 * v138; } if (v59 * v59 < v74.v14 * v86 * v89) { return false; } var v41 = v58(v74.v96); v59 = 0; v86 = 0, v89 = 0; for (v76 = 0; v76 < v74.v90; v76++) { v140 = v74.v46[v76]; v138 = v41[v76]; v59 += v140 * v138; v86 += v140 * v140; v89 += v138 * v138; } if (v59 * v59 < v74.v14 * v86 * v89) { return false; } v74.v33.push({v123:v84, v88:v88}); return true; } function v15(v23, v115) { $(v23)[0].textContent = v115; } function v2() { var v157 = "s"; if (v74.v54 == 1) { v157 = ""; } v15(".found-clusters", "Found ".concat(v74.v54, ' similar image', v157)); } function v3(v88) { if (v88 + 1 == v74.v65) { return; } v15(".progress-text", "Please wait... Comparing to ".concat(v88, ' from ', v74.v65, ' selected files.')); var v81 = Math.floor(100 * (v88 + 1) / v74.v65); if (v81 < 5) { v81 = 5; } var v72 = "".concat(v81, "%"); $("#progress-bar").width(v72); } function v80(v56, v39) { var v124 = document.createElement("div"); v124.className = v56; v39.appendChild(v124); return v124; } var v52 = document.getElementById("clusters"); function v27(v88) { var v129 = v57(v88); v129.id = v88; v52.appendChild(v129); v74.v33.sort(function(v150, v159) { if (v150.v123 > v159.v123) { return 1; } if (v150.v123 < v159.v123) { return -1; } return 0; }); var v153 = 0; for (v153 = 0; v153 < v74.v33.length; v153++) { document.getElementById(v74.v33[v153].v88).style.order = v153; } } function v57(v88) { var v126 = new Image(); var v129 = document.createElement("div"); v129.className = "cluster"; v129.id = v88; v129.title = v74.v85; var v32 = v80("cluster-content", v129); var v77 = v80("cluster-imgs", v32); var v92 = v80("cluster-img-div", v77); v126.width = v74.v43; v92.appendChild(v126); v126.classList.add("cluster-img"); var v64 = v80("image-size", v92); v64.textContent = "".concat(v74.v148, "×", v74.v142); var v24 = v80("cluster-paths", v32); var v63 = v80("img-path", v24); v63.textContent = v74.v102[v88].webkitRelativePath; v30(v88, v126, v64); return v129; } function v30(v88, v126, v64) { var v93 = new FileReader(); v93.onload = function() { return function(e) { var v55 = new Image(); v55.src = e.target.result; var v94 = document.createElement("canvas"); var v134 = v94.getContext("2d"); v55.onload = function() { v64.textContent = "".concat(v55.width, "×", v55.height); if (v55.width >= v55.height) { v94.height = v74.v43 * 2; v94.width = ~~(v55.width * v94.height / v55.height); } else { v94.width = v74.v43 * 2; v94.height = ~~(v55.height * v94.width / v55.width); } v126.width = v94.width / 2; v126.height = v94.height / 2; v134.drawImage(v55, 0, 0, v94.width, v94.height); v126.src = v94.toDataURL(v74.v12, v74.v9); v94 = null; v134 = null; v55 = null; v93 = null; v74.v10++; }; }; } (); v93.readAsDataURL(v74.v102[v88]); } function v62() { var v114 = ""; var v153 = 0; for (v153 = 0; v153 < v74.v33.length; v153++) { v114 = v114.concat(v74.v102[v74.v33[v153].v88].webkitRelativePath, v74.v37); } v114 = v114.slice(0, -1); $(".textarea").val(v114); $(".textarea").toggleClass("textareaon"); } function v16() { $("#terms-of-service").hide(); $(".text-left").hide(); $(".vertical-center-row").toggleClass("vertical-center-narrow"); v74.v0 = setTimeout(function() { $("#messages").text('Please wait if you selected a very large number of images: it may take tens of seconds before the clustering starts.'); $("#messages").show(); $("#image-selector").hide(); $("#folder-selector").hide(); v74.v70 = $("#fast-option")[0].checked; $("#fast").hide(); $("#cancel-link").show(); }, v74.v1); } function v118(v158) { return Math.floor(Math.random() * v158); } function v149(v153, v162, v110) { return v110 * v162 + v153; } function v137(v149, v110) { var v162 = Math.floor(v149 / v110); var v153 = v149 - v110 * v162; return [v153, v162]; } function v119(v82, v153, v162, v110) { var v160 = v82[v162 * (v110 * 4) + (v153 * 4) ]; var v156 = v82[v162 * (v110 * 4) + (v153 * 4) + 1]; var v159 = v82[v162 * (v110 * 4) + (v153 * 4) + 2]; var v150 = v82[v162 * (v110 * 4) + (v153 * 4) + 3]; return [v160, v156, v159, v150]; } function v67() { var v155 = 0, v152 = 0, v143 = 0, v144= 0, v69 = 0; for (v155 = 1; v155 < v74.v91 - 1; v155++) { for (v152 = 1; v152 < v74.v91 - 1; v152++) { var v18 = new Map(); for (v143 = -1; v143 < 2; v143++) { for (v144 = -1; v144 < 2; v144++) { v18.set((v152 + v144) * v74.v91 + v155 + v143, true); }} v74.v101[v69] = v18; v74.v90++; v69++; }} return; } v67(); function v66(v155, v152, v91) { if (v155 < 0 || v152 < 0 || v155 >= v91 || v152 >= v91) { return true; } return false; } function v50(v82) { var v107 = []; var v153 = 0, v162 = 0, v161 = 0, v158 = 0; var v160 = 0, v156 = 0, v159 = 0; var v132 = 0, v157 = 0; var v76 = 0; var v100 = []; var v103 = []; var v83 = []; for (v146 = 0; v146 < v74.v101.length; v146++) { v132 = 0; v157 = 0; for (var [v149, v104] of v74.v101[v146]) { v100 = v137(v149, v74.v91); v153 = v100[0]; v162 = v100[1]; for (v151 = 0; v151 < v73.v34; v151++) { v103 = v137(v151, v74.v44); v161 = v103[0]; v158 = v103[1]; v83 = v119(v82, v153 * v74.v44 + v161, v162 * v74.v44 + v158, v73.v122); v160 = v83[0]; v156 = v83[1]; v159 = v83[2]; switch (v146 % 3) { case 0: v132 += v160; v157++; break; case 1: v132 += v156; v157++; break; case 2: v132 += v160 + v156 + v159; v157 += 3; } } } v107[v76] = v132 / v157; v76++; } return v107; } function v58(v133) { var v87 = []; var v154 = v133.length; var v113 = 0; var v121 = Number.POSITIVE_INFINITY; var v111 = 0; var v109 = Number.POSITIVE_INFINITY; var v112 = 0; var v108 = Number.POSITIVE_INFINITY; for (v158 = 0; v158 < v154; v158 += 3) { if (v133[v158] > v113) { v113 = v133[v158]; } if (v133[v158] < v121) { v121 = v133[v158]; } } for (v158 = 1; v158 < v154; v158 += 3) { if (v133[v158] > v111) { v111 = v133[v158]; } if (v133[v158] < v109) { v109 = v133[v158]; } } for (v158 = 2; v158 < v154; v158 += 3) { if (v133[v158] > v112) { v112 = v133[v158]; } if (v133[v158] < v108) { v108 = v133[v158]; } } var v130 = v113 - v121; var v127 = v111 - v109; var v125 = v112 - v108; for (v158 = 0; v158 < v154; v158 += 3) { v87[v158] = (v133[v158 ] - v121) * 255 / v130; } for (v158 = 1; v158 < v154; v158 += 3) { v87[v158] = (v133[v158 ] - v109) * 255 / v127; } for (v158 = 2; v158 < v154; v158 += 3) { v87[v158] = (v133[v158 ] - v108) * 255 / v125; } return v87; } </script> </body> </html>