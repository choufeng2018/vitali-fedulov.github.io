<!-- Copyright by Vitali Fedulov (www.similar.pictures) 2015-2019 -->
<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Similar image search on disk</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="js/jquery.min.js"></script>
        <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto">
        <link rel="icon" type="image/png" href="images/favicon.png">
        <link rel="stylesheet" type="text/css" href="css/clustering.css">
    </head>
    <body>
        <div class="flex-container-select-files">
            <div class="flex-center-horizontally">
                <div>
                    <h1 class="text-centered clustering-title">Similar Image Search</h1>
                </div>
                <div id="terms-of-service">
                    <p class="terms-of-service-header text-centered">Terms of service and data protection</p>
                    <div id="terms"></div>
                </div>
                <div>
                    <p id="messages" class="hidden">Messages</p>
                    <div id="ok-button" class="text-centered">
                        <div class="button">OK</div>
                    </div>
                    <div id="image-selector" class="text-centered margin-bottom">
                        <input type="file" accept="image/*" class="hidden" id="imageSelected" onchange="v8(this.files)">
                        <a class="button" id="button-image-select">1. Select image to search
 </a>
                    </div>
                    <div id="folder-selector" class="text-centered">
                        <input type="file" accept="image/*" webkitdirectory multiple class="hidden" id="filesSelected" onchange="v53(this.files)" onclick="v18()">
                        <a class="button button-passive" id="button-folder-select">2. Where to search (select folder)
 </a>
                    </div>
                    <div id="fast" class="fast-option">
                        <input type="checkbox" id="fast-option" onclick="v7()">
                        <div class="fast-option-text">Check here to accelerate the search. In rare cases this option may skip some images.</div>
                    </div>
                    <div class="link-block text-centered">
                        <a class="home-cancel-link" id="cancel-link" onclick="v51()">Cancel</a>
                        <a class="home-cancel-link" href="/">Home</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="fixed-top hidden">
            <div class="fixed-top-gray">
                <a href="index.html" class="myhref">
                    <span class="logo">
                        Similar<span class="logo-dot">.</span>Pictures
                    </span>
                </a>
                <div class="button button-new-search">New search</div>
            </div>
            <div class="fixed-white-1">
                <div class="progress">
                    <div id="progress-bar"></div>
                </div>
                <div class="progress-text"></div>
            </div>
            <div class="fixed-white-2 hidden">
                <span class="found-clusters"></span>
                <span>(</span>
                <span class="view-list">show/hide as list</span>
                <span>)</span>
                <textarea class="textarea"></textarea>
                <p class="explanation">
                    <small class="small">The most similar images appear on top. Keep the browser tab open to avoid stopping the search.</small>
                </p>
            </div>
        </div>
        <div id="clusters" class="found-images"></div>
        <script>
            $(document).ready(function() {
                $("#terms").load("tos_en.html");
                v5();
                $("#ok-button").hide();
                $("#cancel-link").hide();
                $(".button-new-search").click(v62);
                $("#ok-button").click(v62);
            });

            var v73 = {

                v86: 24,
                v48: 12,
                v54: 80000,
                v11: 20 * 1024 * 1024,
                v69: 0,
                v63: 0,
                v21: Date.now(),

                v74: false,

                v90: 0,
                v94: [],

                v98: [],
                v147: 0,
                v136: 0,
                v44: [],
                v101: [],
                v135: 0,
                v141: 0,

                v56: 0,
                v33: [],

                v36: [],
                v38: 50,
                v13: 0.95,
                v132: 10,
                v119: 100,
                v41: [],
                v31: /(^image\/gif$)|(^image\/jpeg$)|(^image\/jpg$)|(^image\/bmp$)|(^image\/png$)|(^image\/webp$)/,
                v76: "",
                v45: (function() {
                    var v20 = new Uint32Array(10);
                    window.crypto.getRandomValues(v20);
                    var v47 = "";
                    var v150 = 0;
                    for (v150 = 0; v150 < v20.length; v150++) {
                        v47 += v20[v150].toString(36);
                    }
                    return v47
                }
                )(),

                v96: null,
                v59: 0,

                v28: false,

                v1: 1000,
                v0: null,
                v16: "image/jpeg",
                v10: 0.6,
                v43: 160,
                v37: '\n',
                v19: 0,
                v12: false,
                v9: 0,
            };

            var v70 = {
                v35: v73.v48 * v73.v48,
                v120: v73.v86 * v73.v48,
                v80: v73.v86 * v73.v86,
            };

            function v4() {
                return Math.floor((Date.now() - v73.v21) / 1000);
            }

            function v7() {
                localStorage.setItem("fast-option", $("#fast-option")[0].checked);
                return;
            }

            function v5() {
                if (localStorage.getItem("fast-option") == "true") {
                    $("#fast-option")[0].checked = true;
                }
                return;
            }

            function v51() {
                v62();
            }

            function v62() {
                location.reload();
                $(document).ready(function() {
                    $(this).scrollTop(0);
                });
            }

            document.getElementById('image-selector').addEventListener('click', v26);

            function v26() {
                document.getElementById('imageSelected').click();
            }

            function v14() {
                document.getElementById('image-selector').removeEventListener('click', v26);
                document.getElementById('folder-selector').addEventListener('click', v22);
                $("#button-image-select").addClass("button-passive");
                $("#button-folder-select").removeClass("button-passive");
                $("#cancel-link").show();
            }

            function v22() {
                var v105 = document.getElementById('filesSelected');
                if (!!v105.webkitdirectory == false) {
                    alert('This browser does not support folder selection. Please try latest Chrome, Firefox or Edge.');
                    return;
                }
                v105.click();
            }

            function v8(v96) {

                const v34 = v96[0];
                var v92 = new FileReader();
                var v129 = new Image();
                var v89 = document.createElement("canvas");
                v89.width = v70.v120;
                v89.height = v70.v120;
                var v133 = v89.getContext("2d");

                v6();

                v92.onerror = function() {
                    v30();
                    return;
                }
                ;

                v92.onload = function() {
                    return function(e) {
                        v129.src = e.target.result;

                        v129.onerror = function() {
                            v30();
                            return;
                        }
                        ;

                        v129.onload = function() {
                            return function(e2) {
                                v133.drawImage(v129, 0, 0, v70.v120, v70.v120);
                                v73.v98 = v52(v133.getImageData(0, 0, v70.v120, v70.v120).data);

                                v73.v44 = v57(v73.v98);

                                v73.v147 = v129.width;
                                v73.v136 = v129.height;

                                v14();
                            }
                            ;
                        }();
                    }
                    ;
                }();
                v92.readAsDataURL(v96[0]);
            }

            function v30() {
                $("#messages").text('ERROR. The selected image cannot be read. Please select another image (or the same image in a different format).');
                $("#messages").show();
                $("#cancel-link").show();
            }

            function v6() {
                $("#terms-of-service").show();
                $("#messages").hide();
                $("#cancel-link").hide();
            }

            function v53(v96) {
                v73.v9 = 0;
                clearTimeout(v73.v0);
                $("#folder-selector").hide();
                v73.v96 = v96;
                v73.v76 = v96[0].webkitRelativePath.split("/")[0];
                v73.v59 = v96.length;
                var v87 = 0;
                var v104 = 0;
                var v92 = new FileReader();
                var v129 = new Image();
                var v89 = document.createElement("canvas");
                v89.width = v70.v120;
                v89.height = v70.v120;
                var v133 = v89.getContext("2d");
                $(".flex-container-select-files").hide();
                $(".fixed-top").show();
                $(".view-list").click(v66);
                $(".fixed-white-2").show();
                v2();
                v40(v87, v104, v92, v129, v133);
            }
            function v40(v87, v104, v92, v129, v133) {

                if (v87 >= v73.v59) {
                    v27(v87);
                    return;
                }

                if (!v73.v31.test(v73.v96[v87].type) || v73.v96[v87].size > v73.v11) {
                    v87++;
                    v40(v87, v104, v92, v129, v133);
                    return;
                }

                if (v73.v74 && v73.v96[v87].type == "image/jpeg" && !v73.v28) {

                    v42(v92, v104, v73.v96[v87], function(v109) {

                        if (v109 == null) {
                            v73.v28 = true;
                            v40(v87, v104, v92, v129, v133);
                            return;

                        } else {

                            v129.src = URL.createObjectURL(v109);

                            v129.onload = function() {

                                v73.v19++;
                                if (v87 < 5 || v87 % 5 === 0) {
                                    v3(v87);
                                }
                                v133.drawImage(v129, 0, 0, v70.v120, v70.v120);

                                v73.v101 = v52(v133.getImageData(0, 0, v70.v120, v70.v120).data);
                                v73.v135 = v129.width;
                                v73.v141 = v129.height;

                                v73.v69 = v104 + 1;
                                v73.v63 = v87 + 1;

                                if (v83(v87)) {
                                    v73.v56++;
                                    v25(v87);
                                    v2();
                                }

                                v87++;
                                v104++;

                                if (!v73.v12) {
                                    v73.v12 = true;
                                }
                                v73.v28 = false;
                                URL.revokeObjectURL(v129.src);
                                v40(v87, v104, v92, v129, v133);
                                return;
                            }
                            ;

                            v129.onerror = function() {
                                URL.revokeObjectURL(v129.src);
                                v73.v28 = true;
                                v40(v87, v104, v92, v129, v133);
                                return;
                            }
                            ;

                            return;
                        }
                    });

                } else {
                    v73.v28 = true;
                }

                if (v73.v28 == false) {
                    return;
                }

                v92.readAsDataURL(v73.v96[v87]);

                v92.onerror = function() {
                    v87++;
                    v73.v28 = false;
                    v40(v87, v104, v92, v129, v133);
                    return;
                }
                ;

                v92.onload = function(evt) {
                    v129.src = evt.target.result;

                    v129.onerror = function() {
                        v87++;
                        v73.v28 = false;
                        v40(v87, v104, v92, v129, v133);
                        return;
                    }
                    ;

                    v129.onload = function() {
                        v73.v19++;
                        if (v87 < 5 || v87 % 5 === 0) {
                            v3(v87);
                        }
                        v133.drawImage(v129, 0, 0, v70.v120, v70.v120);

                        v73.v101 = v52(v133.getImageData(0, 0, v70.v120, v70.v120).data);
                        v73.v135 = v129.width;
                        v73.v141 = v129.height;

                        v73.v69 = v104 + 1;
                        v73.v63 = v87 + 1;

                        if (v83(v87)) {
                            v73.v56++;
                            v25(v87);
                            v2();

                        }

                        v87++;
                        v104++;

                        if (!v73.v12) {
                            v73.v12 = true;
                        }
                        v73.v28 = false;
                        URL.revokeObjectURL(v129.src);
                        v40(v87, v104, v92, v129, v133);
                        return;
                    }
                    ;
                }
                ;
            }

            function v42(v92, v104, v114, v75) {
                v92.readAsArrayBuffer(v114.slice(0, v73.v54));
                v92.onload = function(v95) {
                    var v106 = new Uint8Array(v95.target.result), v103, v130;
                    for (var v150 = 2; v150 < v106.length; v150++) {
                        if (v106[v150] == 0xFF) {
                            if (!v103) {
                                if (v106[v150 + 1] == 0xD8) {
                                    v103 = v150;
                                }
                            } else {
                                if (v106[v150 + 1] == 0xD9) {
                                    v130 = v150 + 2;
                                    break;
                                }
                            }
                        }
                    }
                    if (v103 && v130) {
                        v75(new Blob([v106.subarray(v103, v130)],{
                            type: "image/jpeg"
                        }));
                    } else {
                        v75(null);
                    }
                }
                ;

                v92.onerror = function() {
                    v75(null);
                }
                ;
            }

            function v27(v87) {
                if (v73.v19 < 2) {
                    $(".fixed-top").hide();
                    $(".flex-container-select-files").show();
                    $("#messages").text("The selected folder has less than 2 images of supported types. There is nothing to compare. Please select a different folder.");
                    $("#messages").show();
                    $("#folder-selector").hide();
                    $("#cancel-link").hide();
                    $("#ok-button").show();
                    return;
                }
                $(".progress")[0].remove();
                var v148 = "s";
                if (v87 + 1 == 1) {
                    v148 = "";
                }
                v17(".progress-text", "Successfully scanned ".concat(v73.v96.length, " file", v148, "."));
                if (v73.v56 == 0) {
                    v17(".progress-text", "Zero similar images found from the successfully scanned ".concat(v73.v96.length, " file", v148, "."));
                }
                return;
            }

            function v83(v87) {
                var v139 = 0
                  , v138 = 0
                  , v108 = 0
                  , v77 = 0;
                var v60 = 0
                  , v93 = 0
                  , v85 = 0;
                var v137 = 0
                  , v142 = 0
                  , v143 = 0
                  , v140 = 0;

                v137 = v73.v147,
                v142 = v73.v136;
                v143 = v73.v135,
                v140 = v73.v141;
                if (v137 * v140 * v73.v119 + v73.v132 * v137 * v143 < v143 * v142 * v73.v119 || v137 * v140 * v73.v119 > v143 * v142 * v73.v119 + v73.v132 * v137 * v143) {
                    return false;
                }

                for (v71 = 0; v71 < v73.v90; v71++) {
                    v139 = v73.v98[v71];
                    v138 = v73.v101[v71];
                    v108 = Math.abs(v139 - v138);
                    if (v108 > v73.v38) {
                        return false;
                    }
                    v77 += v108;
                }

                for (v71 = 0; v71 < v73.v90; v71++) {
                    v139 = v73.v98[v71];
                    v138 = v73.v101[v71];
                    v60 += v139 * v138;
                    v93 += v139 * v139;
                    v85 += v138 * v138;
                }
                if (v60 * v60 < v73.v13 * v93 * v85) {
                    return false;
                }

                var v46 = v57(v73.v101);
                v60 = 0;
                v93 = 0,
                v85 = 0;
                for (v71 = 0; v71 < v73.v90; v71++) {
                    v139 = v73.v44[v71];
                    v138 = v46[v71];
                    v60 += v139 * v138;
                    v93 += v139 * v139;
                    v85 += v138 * v138;
                }
                if (v60 * v60 < v73.v13 * v93 * v85) {
                    return false;
                }

                v73.v36.push({
                    v108: v77,
                    v87: v87
                });
                return true;
            }

            function v17(v23, v118) {
                $(v23)[0].textContent = v118;
            }

            function v2() {
                var v148 = "s";
                if (v73.v56 == 1) {
                    v148 = "";
                }
                v17(".found-clusters", "Found ".concat(v73.v56, ' similar image', v148));
            }

            function v3(v87) {
                if (v87 + 1 == v73.v59) {
                    return;
                }
                v17(".progress-text", "Please wait... Comparing to ".concat(v87, ' from ', v73.v59, ' selected files.'));
                var v79 = Math.floor(100 * (v87 + 1) / v73.v59);
                if (v79 < 5) {
                    v79 = 5;
                }
                var v72 = "".concat(v79, "%");
                $("#progress-bar").width(v72);
            }
            function v82(v50, v39) {
                var v121 = document.createElement("div");
                v121.className = v50;
                v39.appendChild(v121);
                return v121;
            }

            var v55 = document.getElementById("clusters");
            function v25(v87) {

                var v125 = v64(v87);
                v125.id = v87;
                v55.appendChild(v125);

                v73.v36.sort(function(v159, v156) {
                    if (v159.v108 > v156.v108) {
                        return 1;
                    }
                    if (v159.v108 < v156.v108) {
                        return -1;
                    }
                    return 0;
                });

                var v150 = 0;
                for (v150 = 0; v150 < v73.v36.length; v150++) {
                    document.getElementById(v73.v36[v150].v87).style.order = v150;
                }
            }

            function v64(v87) {
                var v129 = new Image();
                var v125 = document.createElement("div");
                v125.className = "cluster";
                v125.id = v87;
                var v32 = v82("cluster-content", v125);
                var v84 = v82("cluster-imgs", v32);
                var v91 = v82("cluster-img-div", v84);
                v129.width = v73.v43;
                v91.appendChild(v129);
                v129.classList.add("cluster-img");
                var v58 = v82("image-size", v91);
                v58.textContent = "".concat(v73.v135, "×", v73.v141);
                var v24 = v82("cluster-paths", v32);
                var v61 = v82("img-path", v24);
                v61.textContent = v73.v96[v87].webkitRelativePath;
                v29(v87, v129, v58);
                return v125;
            }

            function v29(v87, v129, v58) {
                var v92 = new FileReader();
                v92.onload = function() {
                    return function(e) {
                        var v49 = new Image();
                        v49.src = e.target.result;
                        var v89 = document.createElement("canvas");
                        var v133 = v89.getContext("2d");
                        v49.onload = function() {
                            v58.textContent = "".concat(v49.width, "×", v49.height);
                            if (v49.width >= v49.height) {
                                v89.height = v73.v43 * 2;
                                v89.width = ~~(v49.width * v89.height / v49.height);
                            } else {
                                v89.width = v73.v43 * 2;
                                v89.height = ~~(v49.height * v89.width / v49.width);
                            }
                            v129.width = v89.width / 2;
                            v129.height = v89.height / 2;
                            v133.drawImage(v49, 0, 0, v89.width, v89.height);
                            v129.src = v89.toDataURL(v73.v16, v73.v10);
                            v89 = null;
                            v133 = null;
                            v49 = null;
                            v92 = null;
                            v73.v9++;
                        }
                        ;
                    }
                    ;
                }();
                v92.readAsDataURL(v73.v96[v87]);
            }

            function v66() {
                var v123 = "";
                var v150 = 0;
                for (v150 = 0; v150 < v73.v36.length; v150++) {
                    v123 = v123.concat(v73.v96[v73.v36[v150].v87].webkitRelativePath, v73.v37);
                }
                v123 = v123.slice(0, -1);
                $(".textarea").val(v123);
                $(".textarea").toggleClass("textareaon");
            }

            function v18() {
                $("#terms-of-service").hide();
                $(".text-left").hide();
                $(".vertical-center-row").toggleClass("vertical-center-narrow");
                v73.v0 = setTimeout(function() {
                    $("#messages").text('Please wait if you selected a very large number of images: it may take tens of seconds before the clustering starts.');
                    $("#messages").show();
                    $("#image-selector").hide();
                    $("#folder-selector").hide();
                    v73.v74 = $("#fast-option")[0].checked;
                    $("#fast").hide();
                    $("#cancel-link").show();
                }, v73.v1);
            }

            function v115(v151) {
                return Math.floor(Math.random() * v151);
            }

            function v157(v150, v161, v111) {
                return v111 * v161 + v150;
            }

            function v145(v157, v111) {
                var v161 = Math.floor(v157 / v111);
                var v150 = v157 - v111 * v161;
                return [v150, v161];
            }

            function v113(v81, v150, v161, v111) {
                var v160 = v81[v161 * (v111 * 4) + (v150 * 4)];
                var v152 = v81[v161 * (v111 * 4) + (v150 * 4) + 1];
                var v156 = v81[v161 * (v111 * 4) + (v150 * 4) + 2];
                var v159 = v81[v161 * (v111 * 4) + (v150 * 4) + 3];
                return [v160, v152, v156, v159];
            }

            function v67() {
                var v158 = 0
                  , v154 = 0
                  , v144 = 0
                  , v134 = 0
                  , v68 = 0;
                for (v158 = 1; v158 < v73.v86 - 1; v158++) {
                    for (v154 = 1; v154 < v73.v86 - 1; v154++) {
                        var v15 = new Map();
                        for (v144 = -1; v144 < 2; v144++) {
                            for (v134 = -1; v134 < 2; v134++) {
                                v15.set((v154 + v134) * v73.v86 + v158 + v144, true);
                            }
                        }
                        v73.v94[v68] = v15;
                        v73.v90++;
                        v68++;
                    }
                }
                return;
            }

            v67();

            function v65(v158, v154, v86) {
                if (v158 < 0 || v154 < 0 || v158 >= v86 || v154 >= v86) {
                    return true;
                }
                return false;
            }
            function v52(v81) {

                var v100 = [];
                var v150 = 0
                  , v161 = 0
                  , v153 = 0
                  , v151 = 0;
                var v160 = 0
                  , v152 = 0
                  , v156 = 0;
                var v127 = 0
                  , v148 = 0;
                var v71 = 0;
                var v97 = [];
                var v99 = [];
                var v78 = [];

                for (v146 = 0; v146 < v73.v94.length; v146++) {
                    v127 = 0;
                    v148 = 0;
                    for (var [v157,v102] of v73.v94[v146]) {
                        v97 = v145(v157, v73.v86);
                        v150 = v97[0];
                        v161 = v97[1];
                        for (v149 = 0; v149 < v70.v35; v149++) {
                            v99 = v145(v149, v73.v48);
                            v153 = v99[0];
                            v151 = v99[1];
                            v78 = v113(v81, v150 * v73.v48 + v153, v161 * v73.v48 + v151, v70.v120);
                            v160 = v78[0];
                            v152 = v78[1];
                            v156 = v78[2];
                            switch (v146 % 3) {
                            case 0:
                                v127 += v160;
                                v148++;
                                break;
                            case 1:
                                v127 += v152;
                                v148++;
                                break;
                            case 2:
                                v127 += v160 + v152 + v156;
                                v148 += 3;
                            }
                        }

                    }
                    v100[v71] = v127 / v148;
                    v71++;
                }
                return v100;
            }

            function v57(v126) {
                var v88 = [];
                var v155 = v126.length;
                var v116 = 0;
                var v117 = Number.POSITIVE_INFINITY;
                var v122 = 0;
                var v110 = Number.POSITIVE_INFINITY;
                var v112 = 0;
                var v107 = Number.POSITIVE_INFINITY;
                for (v151 = 0; v151 < v155; v151 += 3) {
                    if (v126[v151] > v116) {
                        v116 = v126[v151];
                    }
                    if (v126[v151] < v117) {
                        v117 = v126[v151];
                    }
                }
                for (v151 = 1; v151 < v155; v151 += 3) {
                    if (v126[v151] > v122) {
                        v122 = v126[v151];
                    }
                    if (v126[v151] < v110) {
                        v110 = v126[v151];
                    }
                }
                for (v151 = 2; v151 < v155; v151 += 3) {
                    if (v126[v151] > v112) {
                        v112 = v126[v151];
                    }
                    if (v126[v151] < v107) {
                        v107 = v126[v151];
                    }
                }
                var v124 = v116 - v117;
                var v131 = v122 - v110;
                var v128 = v112 - v107;
                for (v151 = 0; v151 < v155; v151 += 3) {
                    v88[v151] = (v126[v151] - v117) * 255 / v124;
                }
                for (v151 = 1; v151 < v155; v151 += 3) {
                    v88[v151] = (v126[v151] - v110) * 255 / v131;
                }
                for (v151 = 2; v151 < v155; v151 += 3) {
                    v88[v151] = (v126[v151] - v107) * 255 / v128;
                }
                return v88;
            }
        </script>
    </body>
</html>
