<!-- Copyright by Vitali Fedulov (fedulov.vitali@gmail.com) 2015-2019 -->
<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Similar image search on disk</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="js/jquery.min.js"></script>
        <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto">
        <link rel="icon" type="image/png" href="images/favicon.png">
        <link rel="stylesheet" type="text/css" href="css/clustering.css">
    </head>
    <body>
        <div class="flex-container-select-files">
            <div class="flex-center-horizontally">
                <div>
                    <h1 class="text-centered clustering-title">Similar Image Search</h1>
                </div>
                <div id="terms-of-service">
                    <p class="terms-of-service-header text-centered">Terms of service and data protection</p>
                    <div id="terms"></div>
                </div>
                <div>
                    <p id="messages" class="hidden">Messages</p>
                    <div id="ok-button" class="text-centered">
                        <div class="button">OK</div>
                    </div>
                    <div id="image-selector" class="text-centered margin-bottom">
                        <input type="file" accept="image/*" class="hidden" id="imageSelected" onchange="v7(this.files)">
                        <a class="button" id="button-image-select">1. Select image to search
 </a>
                    </div>
                    <div id="folder-selector" class="text-centered">
                        <input type="file" accept="image/*" webkitdirectory multiple class="hidden" id="filesSelected" onchange="v50(this.files)" onclick="v15()">
                        <a class="button button-passive" id="button-folder-select">2. Where to search (select folder)
 </a>
                    </div>
                    <div id="fast" class="fast-option">
                        <input type="checkbox" id="fast-option" onclick="v6()">
                        <div class="fast-option-text">Check here to accelerate the search. In rare cases this option may skip some images.</div>
                    </div>
                    <div class="link-block text-centered">
                        <a class="home-cancel-link" id="cancel-link" onclick="v53()">Cancel</a>
                        <a class="home-cancel-link" href="/">Home</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="fixed-top hidden">
            <div class="fixed-top-gray">
                <a href="index.html" class="myhref">
                    <span class="logo">
                        Similar<span class="logo-dot">.</span>Pictures
                    </span>
                </a>
                <div class="button button-new-search">New search</div>
            </div>
            <div class="fixed-white-1">
                <div class="progress">
                    <div id="progress-bar"></div>
                </div>
                <div class="progress-text"></div>
            </div>
            <div class="fixed-white-2 hidden">
                <span class="found-clusters"></span>
                <span>(</span>
                <span class="view-list">show/hide as list</span>
                <span>)</span>
                <textarea class="textarea"></textarea>
                <p class="explanation">
                    <small class="small">The most similar images appear on top. Keep the browser tab open to avoid stopping the search.</small>
                </p>
            </div>
        </div>
        <div id="clusters" class="found-images"></div>
        <script>
            $(document).ready(function() {
                $("#terms").load("tos_en.html");
                v4();
                $("#ok-button").hide();
                $("#cancel-link").hide();
                $(".button-new-search").click(v63);
                $("#ok-button").click(v63);
            });

            var v77 = {

                v90: 24,
                v46: 12,
                v51: 80000,
                v11: 20 * 1024 * 1024,
                v68: 0,
                v61: 0,
                v20: Date.now(),

                v71: false,

                v92: 0,
                v99: [],

                v105: [],
                v148: 0,
                v147: 0,
                v47: [],
                v93: [],
                v145: 0,
                v149: 0,

                v48: 0,
                v39: [],

                v33: [],
                v38: 50,
                v66: 0.2,
                v69: 0.7,
                v134: 10,
                v113: 100,
                v45: [],
                v30: /(^image\/gif$)|(^image\/jpeg$)|(^image\/jpg$)|(^image\/bmp$)|(^image\/png$)|(^image\/webp$)/,
                v73: "",
                v42: (function() {
                    var v21 = new Uint32Array(10);
                    window.crypto.getRandomValues(v21);
                    var v43 = "";
                    var v161 = 0;
                    for (v161 = 0; v161 < v21.length; v161++) {
                        v43 += v21[v161].toString(36);
                    }
                    return v43
                }
                )(),

                v94: null,
                v57: 0,

                v27: false,

                v1: 1000,
                v0: null,
                v17: "image/jpeg",
                v10: 0.6,
                v44: 160,
                v34: '\n',
                v18: 0,
                v16: false,
                v9: 0,
            };

            var v72 = {
                v37: v77.v46 * v77.v46,
                v114: v77.v90 * v77.v46,
                v78: v77.v90 * v77.v90,
            };

            function v5() {
                return Math.floor((Date.now() - v77.v20) / 1000);
            }

            function v6() {
                localStorage.setItem("fast-option", $("#fast-option")[0].checked);
                return;
            }

            function v4() {
                if (localStorage.getItem("fast-option") == "true") {
                    $("#fast-option")[0].checked = true;
                }
                return;
            }

            function v53() {
                v63();
            }

            function v63() {
                location.reload();
                $(document).ready(function() {
                    $(this).scrollTop(0);
                });
            }

            document.getElementById('image-selector').addEventListener('click', v23);

            function v23() {
                document.getElementById('imageSelected').click();
            }

            function v12() {
                document.getElementById('image-selector').removeEventListener('click', v23);
                document.getElementById('folder-selector').addEventListener('click', v19);
                $("#button-image-select").addClass("button-passive");
                $("#button-folder-select").removeClass("button-passive");
                $("#cancel-link").show();
            }

            function v19() {
                var v100 = document.getElementById('filesSelected');
                if (!!v100.webkitdirectory == false) {
                    alert('This browser does not support folder selection. Please try latest Chrome, Firefox or Edge.');
                    return;
                }
                v100.click();
            }

            function v31() {
                $("#messages").text('ERROR. The selected image cannot be read. Please select another image (or the same image in a different format).');
                $("#messages").show();
                $("#cancel-link").show();
            }

            function v8() {
                $("#terms-of-service").show();
                $("#messages").hide();
                $("#cancel-link").hide();
            }

            function v40(v86, v95, v118, v74) {
                v86.readAsArrayBuffer(v118.slice(0, v77.v51));
                v86.onload = function(v98) {
                    var v101 = new Uint8Array(v98.target.result), v103, v123;
                    for (var v161 = 2; v161 < v101.length; v161++) {
                        if (v101[v161] == 0xFF) {
                            if (!v103) {
                                if (v101[v161 + 1] == 0xD8) {
                                    v103 = v161;
                                }
                            } else {
                                if (v101[v161 + 1] == 0xD9) {
                                    v123 = v161 + 2;
                                    break;
                                }
                            }
                        }
                    }
                    if (v103 && v123) {
                        v74(new Blob([v101.subarray(v103, v123)],{
                            type: "image/jpeg"
                        }));
                    } else {
                        v74(null);
                    }
                }
                ;

                v86.onerror = function() {
                    v74(null);
                }
                ;
            }

            function v22(v89) {
                if (v77.v18 < 2) {
                    $(".fixed-top").hide();
                    $(".flex-container-select-files").show();
                    $("#messages").text("The selected folder has less than 2 images of supported types. There is nothing to compare. Please select a different folder.");
                    $("#messages").show();
                    $("#folder-selector").hide();
                    $("#cancel-link").hide();
                    $("#ok-button").show();
                    return;
                }
                $(".progress")[0].remove();
                var v164 = "s";
                if (v89 + 1 == 1) {
                    v164 = "";
                }
                v14(".progress-text", "Successfully scanned ".concat(v77.v94.length, " file", v164, "."));
                if (v77.v48 == 0) {
                    v14(".progress-text", "Zero similar images found from the successfully scanned ".concat(v77.v94.length, " file", v164, "."));
                }
                return;
            }

            function v70() {
                var v162 = 0
                  , v155 = 0
                  , v137 = 0
                  , v146 = 0
                  , v67 = 0;
                for (v162 = 1; v162 < v77.v90 - 1; v162++) {
                    for (v155 = 1; v155 < v77.v90 - 1; v155++) {
                        var v13 = new Map();
                        for (v137 = -1; v137 < 2; v137++) {
                            for (v146 = -1; v146 < 2; v146++) {
                                v13.set((v155 + v146) * v77.v90 + v162 + v137, true);
                            }
                        }
                        v77.v99[v67] = v13;
                        v77.v92++;
                        v67++;
                    }
                }
                return;
            }

            v70();
            var v65 = v77.v92 * v77.v38 * v77.v38 * v77.v66;

            function v83(v89) {
                var v138 = 0
                  , v139 = 0
                  , v84 = 0
                  , v126 = 0;
                var v144 = 0
                  , v140 = 0
                  , v143 = 0
                  , v150 = 0;

                v144 = v77.v148,
                v140 = v77.v147;
                v143 = v77.v145,
                v150 = v77.v149;
                if (v144 * v150 * v77.v113 + v77.v134 * v144 * v143 < v143 * v140 * v77.v113 || v144 * v150 * v77.v113 > v143 * v140 * v77.v113 + v77.v134 * v144 * v143) {
                    return false;
                }

                v84 = 0;
                for (v76 = 0; v76 < v77.v92; v76++) {
                    v138 = v77.v105[v76];
                    v139 = v77.v93[v76];
                    v84 += (v138 - v139) * (v138 - v139);
                }
                if (v84 > v65) {
                    return false;
                }

                v126 = 0;
                v47 = v64(v77.v105);
                v41 = v64(v77.v93);
                for (v76 = 0; v76 < v77.v92; v76++) {
                    v138 = v47[v76];
                    v139 = v41[v76];
                    v126 += (v138 - v139) * (v138 - v139);
                }
                if (v126 > v65) {
                    return false;
                }

                v126 = 0;
                for (v76 = 0; v76 < v77.v92 - 1; v76++) {
                    v136 = v77.v105[v76];
                    v131 = v77.v105[v76 + 1];
                    v135 = v77.v93[v76];
                    v132 = v77.v93[v76 + 1];
                    if (((v136 > v131) && (v135 > v132)) || ((v136 < v131) && (v135 < v132)) || ((v136 == v131) && (v135 == v132))) {
                        v126++;
                    }
                }
                if (v126 < v77.v92 * v77.v69) {
                    return false;
                }

                v77.v33.push({
                    v117: v84,
                    v89: v89
                });
                return true;
            }

            function v14(v24, v122) {
                $(v24)[0].textContent = v122;
            }

            function v2() {
                var v164 = "s";
                if (v77.v48 == 1) {
                    v164 = "";
                }
                v14(".found-clusters", "Found ".concat(v77.v48, ' similar image', v164));
            }

            function v3(v89) {
                if (v89 + 1 == v77.v57) {
                    return;
                }
                v14(".progress-text", "Please wait... Comparing to ".concat(v89, ' from ', v77.v57, ' selected files.'));
                var v80 = Math.floor(100 * (v89 + 1) / v77.v57);
                if (v80 < 5) {
                    v80 = 5;
                }
                var v75 = "".concat(v80, "%");
                $("#progress-bar").width(v75);
            }
            function v85(v49, v36) {
                var v115 = document.createElement("div");
                v115.className = v49;
                v36.appendChild(v115);
                return v115;
            }

            var v52 = document.getElementById("clusters");
            function v26(v89) {

                var v128 = v62(v89);
                v128.id = v89;
                v52.appendChild(v128);

                v77.v33.sort(function(v157, v151) {
                    if (v157.v117 > v151.v117) {
                        return 1;
                    }
                    if (v157.v117 < v151.v117) {
                        return -1;
                    }
                    return 0;
                });

                var v161 = 0;
                for (v161 = 0; v161 < v77.v33.length; v161++) {
                    document.getElementById(v77.v33[v161].v89).style.order = v161;
                }
            }

            function v62(v89) {
                var v130 = new Image();
                var v128 = document.createElement("div");
                v128.className = "cluster";
                v128.id = v89;
                var v29 = v85("cluster-content", v128);
                var v79 = v85("cluster-imgs", v29);
                var v88 = v85("cluster-img-div", v79);
                v130.width = v77.v44;
                v88.appendChild(v130);
                v130.classList.add("cluster-img");
                var v56 = v85("image-size", v88);
                v56.textContent = "".concat(v77.v145, "×", v77.v149);
                var v25 = v85("cluster-paths", v29);
                var v59 = v85("img-path", v25);
                v59.textContent = v77.v94[v89].webkitRelativePath;
                v28(v89, v130, v56);
                return v128;
            }

            function v28(v89, v130, v56) {
                var v86 = new FileReader();
                v86.onload = function() {
                    return function(e) {
                        var v54 = new Image();
                        v54.src = e.target.result;
                        var v91 = document.createElement("canvas");
                        var v127 = v91.getContext("2d");
                        v54.onload = function() {
                            v56.textContent = "".concat(v54.width, "×", v54.height);
                            if (v54.width >= v54.height) {
                                v91.height = v77.v44 * 2;
                                v91.width = ~~(v54.width * v91.height / v54.height);
                            } else {
                                v91.width = v77.v44 * 2;
                                v91.height = ~~(v54.height * v91.width / v54.width);
                            }
                            v130.width = v91.width / 2;
                            v130.height = v91.height / 2;
                            v127.drawImage(v54, 0, 0, v91.width, v91.height);
                            v130.src = v91.toDataURL(v77.v17, v77.v10);
                            v91 = null;
                            v127 = null;
                            v54 = null;
                            v86 = null;
                            v77.v9++;
                        }
                        ;
                    }
                    ;
                }();
                v86.readAsDataURL(v77.v94[v89]);
            }

            function v58() {
                var v116 = "";
                var v161 = 0;
                for (v161 = 0; v161 < v77.v33.length; v161++) {
                    v116 = v116.concat(v77.v94[v77.v33[v161].v89].webkitRelativePath, v77.v34);
                }
                v116 = v116.slice(0, -1);
                $(".textarea").val(v116);
                $(".textarea").toggleClass("textareaon");
            }

            function v15() {
                $("#terms-of-service").hide();
                $(".text-left").hide();
                $(".vertical-center-row").toggleClass("vertical-center-narrow");
                v77.v0 = setTimeout(function() {
                    $("#messages").text('Please wait if you selected a very large number of images: it may take tens of seconds before the search starts.');
                    $("#messages").show();
                    $("#image-selector").hide();
                    $("#folder-selector").hide();
                    v77.v71 = $("#fast-option")[0].checked;
                    $("#fast").hide();
                    $("#cancel-link").show();
                }, v77.v1);
            }

            function v112(v163) {
                return Math.floor(Math.random() * v163);
            }

            function v156(v161, v158, v121) {
                return v121 * v158 + v161;
            }

            function v141(v156, v121) {
                var v158 = Math.floor(v156 / v121);
                var v161 = v156 - v121 * v158;
                return [v161, v158];
            }

            function v111(v81, v161, v158, v121) {
                var v152 = v81[v158 * (v121 * 4) + (v161 * 4)];
                var v153 = v81[v158 * (v121 * 4) + (v161 * 4) + 1];
                var v151 = v81[v158 * (v121 * 4) + (v161 * 4) + 2];
                var v157 = v81[v158 * (v121 * 4) + (v161 * 4) + 3];
                return [v152, v153, v151, v157];
            }

            function v60(v162, v155, v90) {
                if (v162 < 0 || v155 < 0 || v162 >= v90 || v155 >= v90) {
                    return true;
                }
                return false;
            }
            function v55(v81) {

                var v97 = [];
                var v161 = 0
                  , v158 = 0
                  , v160 = 0
                  , v163 = 0;
                var v152 = 0
                  , v153 = 0
                  , v151 = 0;
                var v126 = 0
                  , v164 = 0;
                var v76 = 0;
                var v102 = [];
                var v96 = [];
                var v82 = [];

                for (v142 = 0; v142 < v77.v99.length; v142++) {
                    v126 = 0;
                    v164 = 0;
                    for (var [v156,v104] of v77.v99[v142]) {
                        v102 = v141(v156, v77.v90);
                        v161 = v102[0];
                        v158 = v102[1];
                        for (v154 = 0; v154 < v72.v37; v154++) {
                            v96 = v141(v154, v77.v46);
                            v160 = v96[0];
                            v163 = v96[1];
                            v82 = v111(v81, v161 * v77.v46 + v160, v158 * v77.v46 + v163, v72.v114);
                            v152 = v82[0];
                            v153 = v82[1];
                            v151 = v82[2];
                            switch (v142 % 3) {
                            case 0:
                                v126 += v152;
                                v164++;
                                break;
                            case 1:
                                v126 += v153;
                                v164++;
                                break;
                            case 2:
                                v126 += v151;
                                v164++;
                            }
                        }

                    }
                    v97[v76] = v126 / v164;
                    v76++;
                }
                return v97;
            }

            function v64(v125) {
                var v87 = [];
                var v159 = v125.length;
                var v109 = 0;
                var v107 = Number.POSITIVE_INFINITY;
                var v108 = 0;
                var v119 = Number.POSITIVE_INFINITY;
                var v106 = 0;
                var v110 = Number.POSITIVE_INFINITY;
                for (v163 = 0; v163 < v159; v163 += 3) {
                    if (v125[v163] > v109) {
                        v109 = v125[v163];
                    }
                    if (v125[v163] < v107) {
                        v107 = v125[v163];
                    }
                }
                for (v163 = 1; v163 < v159; v163 += 3) {
                    if (v125[v163] > v108) {
                        v108 = v125[v163];
                    }
                    if (v125[v163] < v119) {
                        v119 = v125[v163];
                    }
                }
                for (v163 = 2; v163 < v159; v163 += 3) {
                    if (v125[v163] > v106) {
                        v106 = v125[v163];
                    }
                    if (v125[v163] < v110) {
                        v110 = v125[v163];
                    }
                }
                var v129 = v109 - v107;
                var v124 = v108 - v119;
                var v133 = v106 - v110;
                for (v163 = 0; v163 < v159; v163 += 3) {
                    v87[v163] = (v125[v163] - v107) * 255 / v129;
                }
                for (v163 = 1; v163 < v159; v163 += 3) {
                    v87[v163] = (v125[v163] - v119) * 255 / v124;
                }
                for (v163 = 2; v163 < v159; v163 += 3) {
                    v87[v163] = (v125[v163] - v110) * 255 / v133;
                }
                return v87;
            }

            function v7(v94) {
                // If no errors: gray out and remove click event from the "1. Select an image" button.

                const v35 = v94[0];
                var v86 = new FileReader();
                var v130 = new Image();
                var v91 = document.createElement("canvas");
                v91.width = v72.v114;
                v91.height = v72.v114;
                var v127 = v91.getContext("2d");
                v8();

                v86.onerror = function() {
                    v31();
                    return;
                }
                ;
                v86.onload = function() {
                    return function(e) {
                        v130.src = e.target.result;

                        v130.onerror = function() {
                            v31();
                            return;
                        }
                        ;

                        v130.onload = function() {
                            return function(e2) {
                                v127.drawImage(v130, 0, 0, v72.v114, v72.v114);
                                v77.v105 = v55(v127.getImageData(0, 0, v72.v114, v72.v114).data);

                                v77.v47 = v64(v77.v105);

                                v77.v148 = v130.width;
                                v77.v147 = v130.height;

                                v12();
                            }
                            ;
                        }();
                    }
                    ;
                }();
                v86.readAsDataURL(v94[0]);
            }

            function v50(v94) {
                v77.v9 = 0;
                clearTimeout(v77.v0);
                $("#folder-selector").hide();
                v77.v94 = v94;
                v77.v73 = v94[0].webkitRelativePath.split("/")[0];
                v77.v57 = v94.length;
                var v89 = 0;
                var v95 = 0;
                var v86 = new FileReader();
                var v130 = new Image();
                var v91 = document.createElement("canvas");
                v91.width = v72.v114;
                v91.height = v72.v114;
                var v127 = v91.getContext("2d");
                $(".flex-container-select-files").hide();
                $(".fixed-top").show();
                $(".view-list").click(v58);
                $(".fixed-white-2").show();
                v2();
                v32(v89, v95, v86, v130, v127);
            }
            function v32(v89, v95, v86, v130, v127) {

                if (v89 >= v77.v57) {
                    v22(v89);
                    return;
                }

                if (!v77.v30.test(v77.v94[v89].type) || v77.v94[v89].size > v77.v11) {
                    v89++;
                    v32(v89, v95, v86, v130, v127);
                    return;
                }

                if (v77.v71 && v77.v94[v89].type == "image/jpeg" && !v77.v27) {

                    v40(v86, v95, v77.v94[v89], function(v120) {

                        if (v120 == null) {
                            v77.v27 = true;
                            v32(v89, v95, v86, v130, v127);
                            return;

                        } else {

                            v130.src = URL.createObjectURL(v120);

                            v130.onload = function() {

                                v77.v18++;
                                if (v89 < 5 || v89 % 5 === 0) {
                                    v3(v89);
                                }
                                v127.drawImage(v130, 0, 0, v72.v114, v72.v114);

                                v77.v93 = v55(v127.getImageData(0, 0, v72.v114, v72.v114).data);
                                v77.v145 = v130.width;
                                v77.v149 = v130.height;

                                v77.v68 = v95 + 1;
                                v77.v61 = v89 + 1;

                                if (v83(v89)) {
                                    v77.v48++;
                                    v26(v89);
                                    v2();
                                }

                                v89++;
                                v95++;

                                if (!v77.v16) {
                                    v77.v16 = true;
                                }
                                v77.v27 = false;
                                URL.revokeObjectURL(v130.src);
                                v32(v89, v95, v86, v130, v127);
                                return;
                            }
                            ;

                            v130.onerror = function() {
                                URL.revokeObjectURL(v130.src);
                                v77.v27 = true;
                                v32(v89, v95, v86, v130, v127);
                                return;
                            }
                            ;

                            return;
                        }
                    });

                } else {
                    v77.v27 = true;
                }

                if (v77.v27 == false) {
                    return;
                }

                v86.readAsDataURL(v77.v94[v89]);

                v86.onerror = function() {
                    v89++;
                    v77.v27 = false;
                    v32(v89, v95, v86, v130, v127);
                    return;
                }
                ;

                v86.onload = function(evt) {
                    v130.src = evt.target.result;

                    v130.onerror = function() {
                        v89++;
                        v77.v27 = false;
                        v32(v89, v95, v86, v130, v127);
                        return;
                    }
                    ;

                    v130.onload = function() {
                        v77.v18++;
                        if (v89 < 5 || v89 % 5 === 0) {
                            v3(v89);
                        }
                        v127.drawImage(v130, 0, 0, v72.v114, v72.v114);

                        v77.v93 = v55(v127.getImageData(0, 0, v72.v114, v72.v114).data);
                        v77.v145 = v130.width;
                        v77.v149 = v130.height;

                        v77.v68 = v95 + 1;
                        v77.v61 = v89 + 1;

                        if (v83(v89)) {
                            v77.v48++;
                            v26(v89);
                            v2();

                        }

                        v89++;
                        v95++;

                        if (!v77.v16) {
                            v77.v16 = true;
                        }
                        v77.v27 = false;
                        URL.revokeObjectURL(v130.src);
                        v32(v89, v95, v86, v130, v127);
                        return;
                    }
                    ;
                }
                ;
            }
        </script>
    </body>
</html>

