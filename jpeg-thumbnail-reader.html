<!-- Copyright by Vitali Fedulov (www.similar.pictures) 2015-2019 -->
<!DOCTYPE html>
<html lang="en">
    <head>
        <title>JPEG embedded thumbnail reader</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="js/jquery.min.js"></script>
        <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto">
        <link rel="icon" type="image/png" href="images/favicon.png">
        <link rel="stylesheet" type="text/css" href="css/clustering.css">
    </head>
    <body>
        <div class="flex-container-select-files">
            <div class="flex-center-horizontally">
                <div>
                    <h2 class="text-centered clustering-title">JPEG Embedded Thumbnail Reader</h2>
                </div>
                <div id="terms-of-service">
                    <p class="terms-of-service-header text-centered">Terms of service and data protection</p>
                    <div id="terms"></div>
                </div>
                <div>
                    <p id="messages" class="hidden">Messages</p>
                    <div id="ok-button" class="text-centered">
                        <div class="button">OK</div>
                    </div>
                    <div id="file-selector" class="text-centered">
                        <input class="hidden" type="file" id="filesSelected" webkitdirectory multiple accept="image/*" onchange="v32(this.files)" onclick="v9()">
                        <a class="button">Select a folder with images</a>
                    </div>
                    <div class="link-block text-centered">
                        <a class="home-cancel-link" id="cancel-link" onclick="v31()">Cancel</a>
                        <a class="home-cancel-link" href="/">Home</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="fixed-top hidden">
            <div class="fixed-top-gray">
                <a href="index.html" class="myhref">
                    <span class="logo">
                        Similar<span class="logo-dot">.</span>
                        Pictures
                    </span>
                </a>
                <div class="button button-new-search">New read</div>
            </div>
            <div class="fixed-white-1">
                <div class="progress">
                    <div id="progress-bar"></div>
                </div>
                <div class="progress-text"></div>
            </div>
            <div class="fixed-white-2 hidden">
                <span class="found-clusters"></span>
                <span>(</span>
                <span class="view-list">show/hide as list</span>
                <span>)</span>
                <textarea class="textarea"></textarea>
                <p class="explanation">
                    <small class="small">Scroll down to view all thumbnails.</small>
                </p>
            </div>
        </div>
        <div id="clusters" class="clusters"></div>
        <script>
            $(document).ready(function() {
                $("#terms").load("tos_en.html");
                $("#ok-button").hide();
                $("#cancel-link").hide();
                $(".button-new-search").click(v34);
                $("#ok-button").click(v34);
            });

            var v46 = {

                v28: 80000,
                v7: 50 * 1024 * 1024,
                v41: 0,
                v35: 0,
                v13: Date.now(),

                v30: 0,

                v26: [],
                v44: "image/jpeg",
                v48: "",
                v24: (function() {
                    var v11 = new Uint32Array(10);
                    window.crypto.getRandomValues(v11);
                    var v23 = "";
                    for (var i = 0; i < v11.length; i++) {
                        v23 += v11[i].toString(36);
                    }
                    return v23
                }
                )(),

                v58: null,
                v38: 0,

                v1: 1000,
                v0: null,
                v22: '\n',
                v12: 0,
                v8: false,
                v6: 0,
            };

            function v4() {
                return Math.floor((Date.now() - v46.v13) / 1000);
            }

            function v31() {
                v34();
            }

            function v34() {
                location.reload();
                $(document).ready(function() {
                    $(this).scrollTop(0);
                });
            }

            var v25 = document.getElementById('file-selector');
            v25.addEventListener('click', v19);

            function v19() {
                var v61 = document.getElementById('filesSelected');
                if (!!v61.webkitdirectory == false) {
                    alert('This browser does not support folder selection. Please try latest Chrome, Firefox or Edge.');
                    return;
                }
                v61.click();
            }

            function v32(v58) {
                v46.v6 = 0;
                clearTimeout(v46.v0);
                $("#file-selector").hide();
                v46.v58 = v58;
                v46.v48 = v58[0].webkitRelativePath.split("/")[0];
                v46.v38 = v58.length;
                var v54 = 0;
                var v59 = 0;
                $(".flex-container-select-files").hide();
                $(".fixed-top").show();
                $(".view-list").click(v39);
                $(".fixed-white-2").show();
                v2();
                v20(v54, v59);
            }
            function v20(v54, v59) {

                if (v54 >= v46.v38) {
                    v16(v54);
                    return;
                }

                if (v54 < 5 || v54 % 5 === 0) {
                    v3(v54);
                }

                if (!v46.v44 == v46.v58[v54].type || v46.v58[v54].size > v46.v7) {
                    v54++;
                    v20(v54, v59);
                    return;
                }

                v46.v41 = v59 + 1;
                v27(v59, v54, function(v66) {

                    if (v66 == null) {
                        v54++;
                        v59++;
                        v20(v54, v59);
                        return;

                    } else {

                        var v68 = new Image();

                        v68.onload = function() {

                            v46.v12++;

                            v46.v26[v59] = v54;
                            v46.v35 = v54 + 1;

                            v46.v30++;
                            v5(v46.v30);
                            v14(v46.v30 - 1, v59, v68);

                            v54++;
                            v59++;
                            if (!v46.v8) {
                                v46.v8 = true;
                            }

                            URL.revokeObjectURL(v68.src);
                            v2();
                            v20(v54, v59);
                            return;
                        }
                        ;

                        v68.onerror = function() {
                            URL.revokeObjectURL(v68.src);
                            v54++;
                            v59++;
                            v20(v54, v59);
                            return;
                        }
                        ;

                        v68.src = URL.createObjectURL(v66);

                        return;
                    }
                });
            }

            function v27(v59, v54, v47) {
                var v55 = new FileReader();
                v55.readAsArrayBuffer(v46.v58[v54].slice(0, v46.v28));
                v55.onload = function(v57) {
                    var v60 = new Uint8Array(v57.target.result), v62, v69;
                    for (var v70 = 2; v70 < v60.length; v70++) {
                        if (v60[v70] == 0xFF) {
                            if (!v62) {
                                if (v60[v70 + 1] == 0xD8) {
                                    v62 = v70;
                                }
                            } else {
                                if (v60[v70 + 1] == 0xD9) {
                                    v69 = v70 + 2;
                                    break;
                                }
                            }
                        }
                    }
                    if (v62 && v69) {
                        v47(new Blob([v60.subarray(v62, v69)],{
                            type: v46.v44
                        }));
                    } else {
                        v47(null);
                    }
                }
                ;

                v55.onerror = function() {
                    v47(null);
                }
                ;
            }

            function v16(v54) {
                if (v46.v12 == 0) {
                    $(".fixed-top").hide();
                    $(".flex-container-select-files").show();
                    $("#messages").text("No images with embedded thumbnails found. Please select a different folder.");
                    $("#messages").show();
                    $("#file-selector").hide();
                    $("#cancel-link").hide();
                    $("#ok-button").show();
                    return;
                }
                $(".progress")[0].remove();
                var v71 = "s";
                if (v54 + 1 == 1) {
                    v71 = "";
                }
                v10(".progress-text", "Successfully scanned ".concat(v46.v58.length, " file", v71, "."));
                if (v46.v30 == 0) {
                    v10(".progress-text", "Zero thumbnails found from the successfully scanned ".concat(v46.v58.length, " file", v71, "."));
                }
                return;
            }

            function v10(v15, v64) {
                $(v15)[0].textContent = v64;
            }

            function v2() {
                var v71 = "s";
                if (v46.v30 == 1) {
                    v71 = "";
                }
                v10(".found-clusters", "Found ".concat(v46.v30, ' embedded thumbnail', v71));
            }

            function v3(v54) {
                if (v54 + 1 == v46.v38) {
                    return;
                }
                v10(".progress-text", "Please wait... Reading ".concat(v54, ' from ', v46.v38, ' selected files.'));
                var v50 = Math.floor(100 * (v54 + 1) / v46.v38);
                if (v50 < 5) {
                    v50 = 5;
                }
                var v45 = "".concat(v50, "%");
                $("#progress-bar").width(v45);
            }
            function v53(v29, v21) {
                var v63 = document.createElement("div");
                v63.className = v29;
                v21.appendChild(v63);
                return v63;
            }

            var v33 = document.getElementById("clusters");

            function v5(v42) {
                var v36 = v53("cluster", v33);
                var v43 = v53("cluster-num", v36);
                v43.textContent = v42;
                var v18 = v53("cluster-content", v36);
                v53("cluster-imgs", v18);
                v53("cluster-paths", v18);
            }

            function v14(v42, v59, v68) {
                var v49 = $(".cluster-imgs")[v42];
                var v56 = v53("cluster-img-div", v49);
                v68.classList.add("cluster-img");
                v56.appendChild(v68);
                var v37 = v53("image-size", v56);
                v37.textContent = "".concat(v68.width, "×", v68.height);
                var v17 = $(".cluster-paths")[v42];
                var v40 = v53("img-path", v17);
                var v65 = v46.v58[v46.v26[v59]];
                v40.textContent = v65.webkitRelativePath;
                v46.v6++;
            }

            function v39() {
                var v67 = "";
                var v52 = $(".img-path");
                for (v72 = 0; v72 < v52.length; v72++) {
                    var v51 = v52[v72].textContent;
                    v67 = v67.concat(v51, v46.v22);
                }
                v67 = v67.slice(0, -1);
                $(".textarea").val(v67);
                $(".textarea").toggleClass("textareaon");
            }

            function v9() {
                $("#terms-of-service").hide();
                $(".text-left").hide();
                $(".vertical-center-row").toggleClass("vertical-center-narrow");
                v46.v0 = setTimeout(function() {
                    $("#messages").text('Please wait if you selected a very large number of images: it may take tens of seconds before the reading starts.');
                    $("#messages").show();
                    $("#file-selector").hide();
                    $("#fast").hide();
                    $("#cancel-link").show();
                }, v46.v1);
            }
        </script>
    </body>
</html>
